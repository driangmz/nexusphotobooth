<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio X Pro - Advanced</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,700;1,600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE LAYOUT --- */
        html, body { height: 100%; margin: 0; background: #111827; }
        
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height for Mobile */
            overflow: hidden;
        }

        /* Desktop: Row layout */
        @media (min-width: 768px) {
            .app-shell { flex-direction: row; }
            .stage-area { flex: 1; height: 100%; overflow: hidden; display: flex; flex-direction: column; }
            .sidebar-area { width: 320px; height: 100%; border-left: 1px solid #374151; }
        }

        /* Mobile: Column layout with scroll if needed */
        @media (max-width: 767px) {
            .app-shell { overflow-y: auto; } /* Allow body scroll on small phones */
            .stage-area { height: auto; min-height: 60vh; }
            .sidebar-area { height: auto; min-height: 40vh; }
        }

        /* --- FONTS & ANIMATION --- */
        .font-main { font-family: 'Space Grotesk', sans-serif; }
        .font-display { font-family: 'Playfair Display', serif; }
        
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); } }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }
        
        .btn-capture {
            animation: pulse-ring 2s infinite;
            transition: transform 0.1s;
        }
        .btn-capture:active { transform: scale(0.95); animation: none; }
        
        .animate-flash { animation: flash 0.15s ease-out forwards; }

        /* --- UTILS --- */
        .video-mirror { transform: scaleX(-1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { background: rgba(255,255,255,0.1); color: white; border-bottom: 2px solid #8b5cf6; }
        .tab-inactive { color: #9ca3af; }
        
        /* Filters & Frames Classes (Dynamic) */
        .f-sepia { filter: sepia(0.8); }
        .f-bw { filter: grayscale(1); }
        .f-vivid { filter: saturate(2); }
        .f-vintage { filter: sepia(0.4) contrast(1.2) brightness(0.9); }
        .fr-classic { border: 12px solid white; }
        .fr-film { border-left: 20px solid black; border-right: 20px solid black; }
        .fr-polaroid { border: 10px solid white; border-bottom: 50px solid white; }
    </style>
</head>
<body class="font-main text-white">

    <div class="app-shell">
        
        <div class="stage-area bg-gray-900 relative">
            
            <header class="p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/80 to-transparent absolute top-0 w-full pointer-events-none">
                <div class="pointer-events-auto flex items-center gap-2">
                    <div class="w-8 h-8 bg-violet-600 rounded-lg flex items-center justify-center font-bold text-lg">X</div>
                    <span class="font-bold tracking-wide">Studio Pro</span>
                </div>
                <div class="pointer-events-auto bg-black/50 backdrop-blur rounded-full px-3 py-1 text-xs font-mono flex gap-3">
                    <span id="stat-count">üì∏ 0</span>
                    <span id="stat-time" class="text-violet-400">00:00</span>
                </div>
            </header>

            <div class="flex-1 relative flex items-center justify-center overflow-hidden bg-black group">
                <video id="video" autoplay playsinline class="video-mirror w-full h-full object-cover"></video>
                
                <div id="flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-30"></div>
                <div id="countdown" class="absolute inset-0 flex items-center justify-center text-9xl font-black text-white drop-shadow-2xl z-30 hidden">3</div>
                
                <div class="absolute inset-0 pointer-events-none z-10 flex flex-col justify-between p-8">
                    <div id="sticker-display" class="self-end text-6xl drop-shadow-lg hidden">‚ú®</div>
                    <div id="text-display" class="self-center font-display text-4xl text-center drop-shadow-lg hidden"></div>
                    <div class="h-10"></div> </div>

                <div id="cam-error" class="absolute inset-0 bg-gray-900 z-40 flex flex-col items-center justify-center hidden p-6 text-center">
                    <p class="text-red-400 mb-4 text-xl">Camera Blocked</p>
                    <p class="text-sm text-gray-400 mb-6">Please enable camera permissions and ensure you are using HTTPS or localhost.</p>
                    <button onclick="initCamera()" class="px-6 py-2 bg-violet-600 rounded-full hover:bg-violet-500">Retry</button>
                </div>
            </div>

            <div class="bg-gray-900/90 backdrop-blur border-t border-gray-700 p-4 pb-6 flex justify-between items-center z-20">
                
                <div class="flex gap-2">
                    <button onclick="toggleMirror()" id="btn-mirror" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-lg transition-colors text-violet-400" title="Mirror Flip">
                        ‚ü∑
                    </button>
                    <div class="relative">
                        <select id="timer-select" class="appearance-none w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 text-center text-xs font-bold focus:outline-none cursor-pointer">
                            <option value="0">0s</option>
                            <option value="3">3s</option>
                            <option value="5">5s</option>
                        </select>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-xs">‚è±Ô∏è</div>
                    </div>
                </div>

                <button id="shutter-btn" class="btn-capture w-20 h-20 rounded-full border-4 border-gray-200 bg-white flex items-center justify-center shadow-lg relative -top-6 hover:bg-gray-100">
                    <div class="w-16 h-16 rounded-full border-2 border-gray-400"></div>
                </button>

                <div class="flex gap-2">
                    <button onclick="toggleSidebar('effects')" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-lg">
                        ‚ú®
                    </button>
                    <button onclick="toggleSidebar('gallery')" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-lg relative">
                        üñºÔ∏è
                        <div id="gallery-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] flex items-center justify-center hidden">0</div>
                    </button>
                </div>
            </div>
        </div>

        <div class="sidebar-area bg-gray-800 flex flex-col">
            
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('effects')" id="tab-effects" class="flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-active transition-colors">Studio</button>
                <button onclick="switchTab('gallery')" id="tab-gallery" class="flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-inactive transition-colors">Gallery</button>
            </div>

            <div id="content-effects" class="flex-1 overflow-y-auto p-5 space-y-8">
                
                <section>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Color Filters</h3>
                    <div class="flex gap-3 overflow-x-auto pb-2 hide-scrollbar">
                        <button onclick="applyFilter('')" class="flex-shrink-0 w-16 h-16 bg-gray-700 rounded-lg hover:bg-gray-600 border-2 border-transparent focus:border-violet-500 text-xs">Normal</button>
                        <button onclick="applyFilter('f-bw')" class="flex-shrink-0 w-16 h-16 bg-gray-700 rounded-lg hover:bg-gray-600 grayscale flex items-center justify-center text-xs">B&W</button>
                        <button onclick="applyFilter('f-sepia')" class="flex-shrink-0 w-16 h-16 bg-[#704214] rounded-lg hover:opacity-80 text-xs mix-blend-screen flex items-center justify-center">Sepia</button>
                        <button onclick="applyFilter('f-vivid')" class="flex-shrink-0 w-16 h-16 bg-gradient-to-br from-blue-400 to-pink-500 rounded-lg text-xs font-bold flex items-center justify-center text-black">Vivid</button>
                        <button onclick="applyFilter('f-vintage')" class="flex-shrink-0 w-16 h-16 bg-yellow-900 rounded-lg text-xs text-yellow-100 flex items-center justify-center">1980s</button>
                    </div>
                </section>

                <section>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Frames</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="applyFrame('')" class="py-2 bg-gray-700 rounded text-xs">None</button>
                        <button onclick="applyFrame('fr-classic')" class="py-2 bg-gray-700 rounded text-xs border border-white">Classic</button>
                        <button onclick="applyFrame('fr-polaroid')" class="py-2 bg-gray-700 rounded text-xs border-b-4 border-white">Polaroid</button>
                        <button onclick="applyFrame('fr-film')" class="py-2 bg-gray-700 rounded text-xs border-x-4 border-black">Film</button>
                    </div>
                </section>

                <section>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Overlays</h3>
                    <input type="text" id="caption-input" placeholder="Type a caption..." oninput="updateCaption(this.value)" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-violet-500 outline-none mb-3">
                    <div class="flex gap-2">
                        <button onclick="toggleSticker('‚ú®')" class="flex-1 py-2 bg-gray-700 rounded text-xl">‚ú®</button>
                        <button onclick="toggleSticker('üî•')" class="flex-1 py-2 bg-gray-700 rounded text-xl">üî•</button>
                        <button onclick="toggleSticker('üíñ')" class="flex-1 py-2 bg-gray-700 rounded text-xl">üíñ</button>
                        <button onclick="toggleSticker('')" class="flex-1 py-2 bg-red-900/50 text-red-300 rounded text-sm font-bold">Clear</button>
                    </div>
                </section>
            </div>

            <div id="content-gallery" class="hidden flex-1 overflow-y-auto p-5">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold">Session</h2>
                    <button onclick="clearGallery()" class="text-xs text-red-400 hover:text-red-300 underline">Clear All</button>
                </div>
                
                <div id="gallery-grid" class="grid grid-cols-2 gap-3">
                    </div>
                
                <button onclick="downloadAll()" id="btn-download-all" class="w-full mt-6 py-3 bg-white text-black font-bold rounded-xl hover:bg-gray-200 hidden">
                    Download All
                </button>
                
                <div id="empty-state" class="text-center py-10 text-gray-500">
                    <p class="text-4xl mb-2">üì∑</p>
                    <p>No photos yet</p>
                </div>
            </div>

        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // --- LOGIC ---
        
        // 1. Data Store (Local Storage)
        const DB = {
            key: 'studio_x_v3_photos',
            get: () => {
                try { return JSON.parse(localStorage.getItem(DB.key) || '[]'); } 
                catch { return []; }
            },
            add: (dataUrl) => {
                const photos = DB.get();
                photos.unshift({ id: Date.now(), src: dataUrl });
                localStorage.setItem(DB.key, JSON.stringify(photos));
                return photos;
            },
            clear: () => localStorage.removeItem(DB.key)
        };

        // 2. State & Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const shutterBtn = document.getElementById('shutter-btn');
        let stream = null;
        let activeFilter = '';
        let activeFrame = '';
        let isMirrored = true;
        let activeSticker = '';
        let activeText = '';
        let sessionStart = Date.now();

        // 3. Initialization
        async function initCamera() {
            try {
                // Request 720p or best available
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
                    audio: false
                });
                video.srcObject = stream;
                document.getElementById('cam-error').classList.add('hidden');
                
                // Start Timer
                setInterval(() => {
                    const diff = Math.floor((Date.now() - sessionStart)/1000);
                    const m = Math.floor(diff/60).toString().padStart(2, '0');
                    const s = (diff%60).toString().padStart(2, '0');
                    document.getElementById('stat-time').innerText = `${m}:${s}`;
                }, 1000);

            } catch (err) {
                console.error(err);
                document.getElementById('cam-error').classList.remove('hidden');
            }
            renderGallery();
        }

        // 4. Capture Engine
        shutterBtn.addEventListener('click', async () => {
            if(!stream) return;
            shutterBtn.disabled = true;

            // Countdown Logic
            const delay = parseInt(document.getElementById('timer-select').value);
            if(delay > 0) {
                const cdEl = document.getElementById('countdown');
                cdEl.classList.remove('hidden');
                for(let i=delay; i>0; i--) {
                    cdEl.innerText = i;
                    await new Promise(r => setTimeout(r, 1000));
                }
                cdEl.classList.add('hidden');
            }

            // Flash
            const flash = document.getElementById('flash');
            flash.classList.remove('animate-flash');
            void flash.offsetWidth; // Trigger reflow
            flash.classList.add('animate-flash');

            // Process Image
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw Background (White for Polaroids)
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0,0,canvas.width, canvas.height);

            // Calculate Video Dimensions based on Frame
            let dx = 0, dy = 0, dw = canvas.width, dh = canvas.height;
            
            if(activeFrame === 'fr-polaroid') {
                dx = 40; dy = 40; dw = canvas.width - 80; dh = canvas.height - 200; // Leave space at bottom
            } else if(activeFrame === 'fr-classic') {
                dx = 40; dy = 40; dw = canvas.width - 80; dh = canvas.height - 80;
            } else if (activeFrame === 'fr-film') {
                dx = 80; dw = canvas.width - 160; // Side bars
            }

            // Mirror & Filter Context
            ctx.save();
            if(isMirrored) {
                ctx.translate(canvas.width, 0); // Move right
                ctx.scale(-1, 1); // Flip
                // Adjust dx for mirrored coordinate system
                if (activeFrame === 'fr-polaroid' || activeFrame === 'fr-classic' || activeFrame === 'fr-film') {
                     // Since we flipped, drawing at x=40 goes to the far right. 
                     // We need to draw at -width + 40? No, standard logic:
                     // The context is flipped. Drawing at 0,0 draws at top-right.
                     // Drawing at dx, dy should work relatively if calculated from the new origin.
                     // Complex. Easier approach: Draw video full, THEN draw frame on top.
                     // Let's revert specific dx/dy for video drawing for simplicity in this Robust version
                     // and just draw the frame overlay ON TOP.
                     dx = 0; dy = 0; dw = canvas.width; dh = canvas.height;
                }
            }

            // Apply CSS Filters to Canvas
            if(activeFilter === 'f-bw') ctx.filter = 'grayscale(100%)';
            if(activeFilter === 'f-sepia') ctx.filter = 'sepia(100%)';
            if(activeFilter === 'f-vivid') ctx.filter = 'saturate(200%)';
            if(activeFilter === 'f-vintage') ctx.filter = 'sepia(40%) contrast(120%)';

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore(); // Remove mirror/filter for overlays

            // Draw Overlays (Text/Stickers/Frames)
            drawOverlays(ctx, canvas.width, canvas.height);

            // Save
            const url = canvas.toDataURL('image/jpeg', 0.95);
            DB.add(url);
            renderGallery();
            
            shutterBtn.disabled = false;
        });

        function drawOverlays(ctx, w, h) {
            // Frames (Manual Drawing)
            ctx.lineWidth = 0;
            if(activeFrame === 'fr-classic') {
                ctx.strokeStyle = "white"; ctx.lineWidth = 50; ctx.strokeRect(0,0,w,h);
            }
            if(activeFrame === 'fr-polaroid') {
                ctx.fillStyle = "white";
                ctx.fillRect(0, h-150, w, 150); // Bottom
                ctx.lineWidth = 40; ctx.strokeStyle="white"; ctx.strokeRect(0,0,w,h);
            }
            if(activeFrame === 'fr-film') {
                ctx.fillStyle = "black";
                ctx.fillRect(0,0, 60, h); // Left
                ctx.fillRect(w-60, 0, 60, h); // Right
            }

            // Text
            if(activeText) {
                ctx.font = "italic bold 60px serif";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10;
                ctx.fillText(activeText, w/2, h - 80);
            }

            // Sticker
            if(activeSticker) {
                ctx.font = "150px serif";
                ctx.textAlign = "right";
                ctx.fillText(activeSticker, w - 50, 150);
            }
        }

        // 5. UI Helpers
        function toggleMirror() {
            isMirrored = !isMirrored;
            video.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
            document.getElementById('btn-mirror').classList.toggle('text-violet-400', isMirrored);
        }

        function applyFilter(cls) {
            activeFilter = cls;
            video.className = `w-full h-full object-cover transition-all ${isMirrored ? 'video-mirror' : ''} ${cls}`;
        }

        function applyFrame(cls) {
            activeFrame = cls;
            // Remove existing frame classes
            video.classList.remove('fr-classic', 'fr-polaroid', 'fr-film');
            if(cls) video.classList.add(cls);
        }

        function updateCaption(val) {
            activeText = val;
            const el = document.getElementById('text-display');
            el.innerText = val;
            el.classList.toggle('hidden', !val);
        }

        function toggleSticker(emoji) {
            activeSticker = emoji;
            const el = document.getElementById('sticker-display');
            el.innerText = emoji;
            el.classList.toggle('hidden', !emoji);
        }

        function switchTab(tab) {
            // Header
            document.getElementById('tab-effects').className = tab === 'effects' ? 'flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-active transition-colors' : 'flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-inactive transition-colors';
            document.getElementById('tab-gallery').className = tab === 'gallery' ? 'flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-active transition-colors' : 'flex-1 py-4 text-sm font-bold uppercase tracking-wider tab-inactive transition-colors';
            
            // Content
            document.getElementById('content-effects').classList.toggle('hidden', tab !== 'effects');
            document.getElementById('content-gallery').classList.toggle('hidden', tab !== 'gallery');
            
            // Layout Shift for Mobile (Auto-scroll to bottom if gallery selected)
            if(window.innerWidth < 768 && tab === 'gallery') {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        // 6. Gallery Logic
        function renderGallery() {
            const photos = DB.get();
            const grid = document.getElementById('gallery-grid');
            const empty = document.getElementById('empty-state');
            const btn = document.getElementById('btn-download-all');
            const stat = document.getElementById('stat-count');
            const badge = document.getElementById('gallery-badge');

            stat.innerText = `üì∏ ${photos.length}`;
            badge.innerText = photos.length;
            badge.classList.toggle('hidden', photos.length === 0);

            grid.innerHTML = '';
            
            if(photos.length === 0) {
                empty.classList.remove('hidden');
                btn.classList.add('hidden');
                return;
            }

            empty.classList.add('hidden');
            btn.classList.remove('hidden');

            photos.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'relative group aspect-square rounded-lg overflow-hidden border border-gray-700 bg-gray-800';
                div.innerHTML = `
                    <img src="${p.src}" class="w-full h-full object-cover">
                    <a href="${p.src}" download="studio-x-${p.id}.jpg" class="absolute bottom-2 right-2 bg-white text-black p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">‚¨á</a>
                `;
                grid.appendChild(div);
            });
        }

        function clearGallery() {
            if(confirm('Delete all photos?')) {
                DB.clear();
                renderGallery();
            }
        }

        function downloadAll() {
            const photos = DB.get();
            photos.forEach(p => {
                const a = document.createElement('a');
                a.href = p.src;
                a.download = `photo-${p.id}.jpg`;
                a.click();
            });
        }

        // On Load
        window.onload = initCamera;

    </script>
</body>
</html>
