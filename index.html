<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>STUDIO BOOTH PRO | V3 Ultimate</title>
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Palette */
            --color-primary: #00f2ea;
            --color-primary-dim: rgba(0, 242, 234, 0.15);
            --color-secondary: #ff0050;
            --color-accent: #ffee00;
            --color-bg: #000000;
            --color-surface: #121212;
            --color-surface-light: #1e1e1e;
            --color-border: rgba(255, 255, 255, 0.1);
            --color-text-main: #ffffff;
            --color-text-muted: #888888;

            /* Spacing & Layout */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --header-height: 60px;
            --control-height-mobile: 220px;
            --control-width-landscape: 160px;

            /* Animation Curves */
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            color: var(--color-text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Lock scroll */
            position: fixed; /* Prevent iOS bounce */
        }

        /* Flash Override Class */
        body.flash-active {
            background-color: #ffffff !important;
        }
        body.flash-active * {
            visibility: hidden !important;
        }

        /* =========================================
           2. ANIMATIONS
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseRec { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes flashBang { 0% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* =========================================
           3. UI COMPONENT STYLES
           ========================================= */
        
        /* Buttons */
        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--color-border);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-smooth);
            font-size: 1.2rem;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.2); }
        .btn-icon:active { transform: scale(0.9); }

        .btn-pill {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-pill.active {
            background: var(--color-text-main);
            color: var(--color-bg);
            border-color: var(--color-text-main);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* Toggles (Switch) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* =========================================
           4. LAYOUT STRUCTURE
           ========================================= */
        
        #app-root {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        #top-bar {
            height: var(--header-height);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            padding-top: var(--safe-top);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            z-index: 50;
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
        }
        
        .logo-group { display: flex; align-items: center; gap: 8px; }
        .logo-dot { width: 12px; height: 12px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }
        .logo-text { font-weight: 800; font-size: 1rem; letter-spacing: 2px; }

        /* WORKSPACE (Viewfinder) */
        #stage-area {
            flex-grow: 1;
            position: relative;
            background: #050505;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
        }

        .viewfinder-frame {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            transition: all 0.3s var(--ease-smooth);
        }

        /* Aspect Ratio Enforcement via JS or Classes */
        .ratio-16-9 { aspect-ratio: 16/9; width: 100%; height: auto; }
        .ratio-4-3 { aspect-ratio: 4/3; width: auto; height: 100%; }
        .ratio-1-1 { aspect-ratio: 1/1; width: auto; height: 90%; }
        /* On mobile, sometimes we just want to FILL */
        .ratio-fill { width: 100%; height: 100%; }

        video#camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Default Mirror */
        }
        .no-mirror video#camera-feed { transform: scaleX(1); }

        /* OVERLAYS (Grid, Info, Countdown) */
        .overlay-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* Status Bar Overlay */
        .status-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rec-pill {
            background: rgba(20,20,20,0.7);
            backdrop-filter: blur(5px);
            padding: 6px 12px;
            border-radius: 50px;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .rec-dot { width: 8px; height: 8px; background: red; border-radius: 50%; animation: pulseRec 2s infinite; }
        .status-text { font-size: 0.7rem; font-family: monospace; color: #ccc; }

        /* Grid */
        .grid-lines { width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s; }
        .grid-lines.visible { opacity: 1; }
        .grid-h { position: absolute; left: 0; width: 100%; height: 1px; background: rgba(255,255,255,0.3); }
        .grid-v { position: absolute; top: 0; height: 100%; width: 1px; background: rgba(255,255,255,0.3); }

        /* Countdown */
        .countdown-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 8rem; font-weight: 900; color: #fff; text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; transition: opacity 0.2s;
        }

        /* Flash Whiteout */
        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; z-index: 100; pointer-events: none;
        }

        /* CONTROL DECK (The Complex Part) */
        #control-deck {
            flex-shrink: 0;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            z-index: 60;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            /* Default Mobile Portrait Styles */
            width: 100%;
            padding-bottom: calc(15px + var(--safe-bottom));
        }

        /* Filter Scroller */
        .filter-scroller {
            width: 100%;
            overflow-x: auto;
            display: flex;
            gap: 10px;
            padding-bottom: 5px;
            scrollbar-width: none; /* Firefox */
        }
        .filter-scroller::-webkit-scrollbar { display: none; } /* Chrome */

        /* Main Controls Row */
        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* Shutter Button Wrapper */
        .shutter-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex; justify-content: center; align-items: center;
        }
        .shutter-button {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: var(--color-text-main);
            border: 4px solid rgba(255,255,255,0.3);
            cursor: pointer;
            box-shadow: 0 0 0 4px transparent;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 2;
        }
        .shutter-button:active { transform: scale(0.9); background: var(--color-secondary); }
        .shutter-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid var(--primary);
            opacity: 0.5; animation: spin 10s linear infinite; pointer-events: none;
        }

        /* Side Control Groups */
        .ctrl-group { display: flex; gap: 10px; flex: 1; }
        .ctrl-group.left { justify-content: flex-start; }
        .ctrl-group.right { justify-content: flex-end; }

        /* =========================================
           5. RESPONSIVE / ORIENTATION QUERIES
           ========================================= */
        
        /* MOBILE LANDSCAPE TWEAKS */
        @media (orientation: landscape) and (max-width: 900px) {
            #app-root { flex-direction: row; }
            #top-bar { display: none; } /* Hide top bar to save vertical space */
            
            #stage-area { width: auto; height: 100%; padding: 0; }
            .viewfinder-frame { width: 100%; height: 100%; border-radius: 0; border: none; }
            .ratio-16-9, .ratio-4-3, .ratio-1-1 { width: 100%; height: 100%; aspect-ratio: unset; }

            #control-deck {
                width: var(--control-width-landscape);
                height: 100%;
                border-top: none;
                border-left: 1px solid var(--color-border);
                padding-right: calc(15px + var(--safe-right));
                justify-content: center;
                gap: 20px;
            }

            .filter-scroller {
                flex-direction: column;
                height: 150px;
                width: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                order: 1; /* Move filters to top right */
            }

            .main-controls {
                flex-direction: column-reverse;
                height: auto;
                gap: 20px;
                order: 2;
            }

            .ctrl-group { flex-direction: column; width: 100%; align-items: center; justify-content: center; gap: 15px; }
        }

        /* DESKTOP / TABLET TWEAKS */
        @media (min-width: 901px) {
            #stage-area { padding: 40px; }
            .viewfinder-frame { 
                max-width: 1200px; 
                max-height: 80vh; 
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            }
            #control-deck {
                flex-direction: column;
                align-items: center;
                padding: 20px;
                background: #000;
            }
            .main-controls { max-width: 800px; }
            .filter-scroller { justify-content: center; }
        }

        /* =========================================
           6. MODALS & WELCOME
           ========================================= */
        #welcome-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.6s ease;
        }
        .intro-card {
            text-align: center; max-width: 400px; padding: 40px;
            background: linear-gradient(145deg, #111, #0a0a0a);
            border-radius: 30px; border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .intro-title {
            font-size: 3rem; font-weight: 900; margin: 0; line-height: 1;
            background: linear-gradient(to right, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .intro-sub { color: var(--color-text-muted); margin-top: 10px; margin-bottom: 30px; font-size: 0.9rem; }
        
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-wrap.open { display: flex; opacity: 1; }
        .modal-content {
            background: #181818; border: 1px solid #333; width: 90%; max-width: 450px;
            border-radius: 20px; overflow: hidden; animation: popIn 0.3s var(--ease-elastic);
        }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; color: #ccc; font-size: 0.9rem; line-height: 1.6; }
        
        /* Utils */
        .hidden { display: none !important; }
        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }

    </style>
</head>
<body>

    <div id="welcome-overlay">
        <div class="intro-card">
            <div style="color:var(--primary); font-size:0.8rem; font-weight:700; letter-spacing:3px; margin-bottom:15px;">VERSION 3.0</div>
            <h1 class="intro-title">STUDIO<br>BOOTH</h1>
            <p class="intro-sub">Advanced Web Photography Suite<br>Orientation Adaptive â€¢ True Flash Logic</p>
            <button class="btn-pill active" style="padding:15px 40px; font-size:1rem;" onclick="app.boot()">INITIALIZE CAMERA</button>
            <div id="boot-spinner" class="loader hidden"></div>
            <div style="margin-top:20px; font-size:0.75rem; color:#555;">
                <span onclick="ui.modal('privacy')" style="cursor:pointer; text-decoration:underline;">Privacy Policy</span>
            </div>
        </div>
    </div>

    <div id="app-root" class="hidden">
        
        <div id="top-bar">
            <div class="logo-group">
                <div class="logo-dot"></div>
                <div class="logo-text">STUDIO<span style="color:var(--primary)">.PRO</span></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-icon" onclick="ui.modal('settings')" title="Settings">âš™</button>
                <button class="btn-icon" onclick="gallery.open()" title="Gallery">ðŸ–¼</button>
            </div>
        </div>

        <div id="stage-area">
            <div id="viewfinder" class="viewfinder-frame ratio-16-9">
                <video id="camera-feed" autoplay playsinline muted></video>
                
                <div class="overlay-container">
                    <div class="status-bar">
                        <div class="rec-pill">
                            <div class="rec-dot"></div> <span class="status-text">READY</span>
                        </div>
                        <div class="status-text" id="res-tag">1080P</div>
                    </div>

                    <div id="grid-lines" class="grid-lines">
                        <div class="grid-h" style="top:33%"></div><div class="grid-h" style="top:66%"></div>
                        <div class="grid-v" style="left:33%"></div><div class="grid-v" style="left:66%"></div>
                    </div>

                    <div id="countdown" class="countdown-overlay">3</div>
                    <div id="flash-fx" class="flash-overlay"></div>
                </div>
            </div>
        </div>

        <div id="control-deck">
            
            <div class="filter-scroller" id="filter-list">
                </div>

            <div class="main-controls">
                
                <div class="ctrl-group left">
                    <button class="btn-icon" onclick="app.toggleGrid(this)">#</button>
                    <button class="btn-icon" onclick="app.toggleFlash(this)">âš¡</button>
                </div>

                <div class="shutter-wrapper">
                    <div class="shutter-ring"></div>
                    <button class="shutter-button" id="shutter-btn" onclick="app.snap()"></button>
                </div>

                <div class="ctrl-group right">
                    <button class="btn-icon" onclick="app.flipCamera()">â†»</button>
                    <button class="btn-icon" onclick="app.cycleRatio()">1:1</button>
                </div>

            </div>
        </div>

    </div>

    <div id="modal-settings" class="modal-wrap">
        <div class="modal-content">
            <div class="modal-head">
                <h3>Studio Settings</h3>
                <button class="btn-icon" style="width:30px; height:30px;" onclick="ui.closeModals()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="setting-row">
                    <span>Mirror Front Camera</span>
                    <label class="toggle-switch"><input type="checkbox" id="set-mirror" checked onchange="app.updateConfig()"><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <span>Shutter Sound</span>
                    <label class="toggle-switch"><input type="checkbox" id="set-sound" checked><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <span>High Quality Export (PNG)</span>
                    <label class="toggle-switch"><input type="checkbox" id="set-hq"><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <span>Burst Mode (3 shots)</span>
                    <label class="toggle-switch"><input type="checkbox" id="set-burst"><span class="slider"></span></label>
                </div>
                <button class="btn-pill active" style="width:100%; margin-top:20px; text-align:center;" onclick="gallery.clear()">Clear Gallery Cache</button>
            </div>
        </div>
    </div>

    <div id="modal-privacy" class="modal-wrap">
        <div class="modal-content">
            <div class="modal-head"><h3>Privacy</h3><button class="btn-icon" style="width:30px;height:30px;" onclick="ui.closeModals()">âœ•</button></div>
            <div class="modal-body">
                <p><strong>Local Processing Only:</strong> No images are sent to any server. All processing happens within your browser memory.</p>
                <p><strong>Camera Access:</strong> Used strictly for the viewfinder and capture.</p>
                <p><strong>Data Persistence:</strong> Images are cleared when you refresh the page.</p>
            </div>
        </div>
    </div>

    <canvas id="proc-canvas" class="hidden"></canvas>

    <script>
        /**
         * =========================================
         * STUDIO BOOTH PRO V3 - LOGIC CORE
         * =========================================
         */

        // Configuration & State
        const STATE = {
            stream: null,
            isCapturing: false,
            filter: 'none',
            facingMode: 'user', // 'user' or 'environment'
            flashOn: false,
            ratioIndex: 0,
            ratios: [
                { cls: 'ratio-16-9', val: 16/9, name: '16:9' },
                { cls: 'ratio-4-3', val: 4/3, name: '4:3' },
                { cls: 'ratio-1-1', val: 1, name: '1:1' }
            ]
        };

        const CONFIG = {
            mirror: true,
            sound: true,
            hq: false,
            burst: false
        };

        const FILTERS = [
            { id: 'none', name: 'Studio', css: 'none' },
            { id: 'bw', name: 'B&W', css: 'grayscale(100%) contrast(1.2)' },
            { id: 'vivid', name: 'Vivid', css: 'saturate(1.6) contrast(1.1)' },
            { id: 'warm', name: 'Warm', css: 'sepia(0.3) saturate(1.2)' },
            { id: 'cool', name: 'Cool', css: 'hue-rotate(180deg) opacity(0.9)' },
            { id: 'cyber', name: 'Cyber', css: 'hue-rotate(-20deg) saturate(2) contrast(1.2)' },
            { id: 'noir', name: 'Noir', css: 'grayscale(100%) contrast(1.5) brightness(0.8)' },
            { id: 'vintage', name: '1985', css: 'sepia(0.6) contrast(0.8) brightness(1.1)' }
        ];

        // UI Controller
        const ui = {
            el: (id) => document.getElementById(id),
            
            initFilters: () => {
                const container = ui.el('filter-list');
                FILTERS.forEach((f, i) => {
                    const btn = document.createElement('button');
                    btn.className = `btn-pill ${i===0 ? 'active' : ''}`;
                    btn.innerText = f.name;
                    btn.onclick = (e) => {
                        document.querySelectorAll('#filter-list .btn-pill').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        STATE.filter = f.css;
                        ui.el('camera-feed').style.filter = f.css;
                    };
                    container.appendChild(btn);
                });
            },

            modal: (id) => {
                ui.el(`modal-${id}`).classList.add('open');
            },
            
            closeModals: () => {
                document.querySelectorAll('.modal-wrap').forEach(m => m.classList.remove('open'));
            }
        };

        // Application Logic
        const app = {
            
            boot: async () => {
                ui.el('boot-spinner').classList.remove('hidden');
                
                try {
                    const constraints = {
                        video: {
                            facingMode: STATE.facingMode,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    };

                    STATE.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    ui.el('camera-feed').srcObject = STATE.stream;
                    
                    // Initial Config Check
                    app.updateConfig();

                    // Transition UI
                    setTimeout(() => {
                        ui.el('welcome-overlay').style.opacity = 0;
                        ui.el('app-root').classList.remove('hidden');
                        setTimeout(() => ui.el('welcome-overlay').remove(), 600);
                    }, 1000);

                } catch (err) {
                    alert("Camera Access Denied. Please check your browser settings permissions.");
                    location.reload();
                }
            },

            flipCamera: () => {
                STATE.facingMode = STATE.facingMode === 'user' ? 'environment' : 'user';
                if(STATE.stream) {
                    STATE.stream.getTracks().forEach(t => t.stop());
                }
                app.boot();
            },

            toggleFlash: (btn) => {
                STATE.flashOn = !STATE.flashOn;
                btn.style.color = STATE.flashOn ? 'var(--color-accent)' : 'white';
                btn.style.borderColor = STATE.flashOn ? 'var(--color-accent)' : 'var(--color-border)';
            },

            toggleGrid: (btn) => {
                ui.el('grid-lines').classList.toggle('visible');
                btn.style.color = ui.el('grid-lines').classList.contains('visible') ? 'var(--primary)' : 'white';
            },

            cycleRatio: () => {
                STATE.ratioIndex = (STATE.ratioIndex + 1) % STATE.ratios.length;
                const r = STATE.ratios[STATE.ratioIndex];
                
                const vf = ui.el('viewfinder');
                vf.classList.remove('ratio-16-9', 'ratio-4-3', 'ratio-1-1');
                vf.classList.add(r.cls);
                
                // Show toast or label update (optional)
            },

            updateConfig: () => {
                CONFIG.mirror = ui.el('set-mirror').checked;
                CONFIG.sound = ui.el('set-sound').checked;
                CONFIG.hq = ui.el('set-hq').checked;
                CONFIG.burst = ui.el('set-burst').checked;

                const vid = ui.el('camera-feed');
                if (CONFIG.mirror && STATE.facingMode === 'user') {
                    vid.classList.remove('no-mirror');
                } else {
                    vid.classList.add('no-mirror');
                }
            },

            // --- THE SHOT ---
            snap: async () => {
                if (STATE.isCapturing) return;
                STATE.isCapturing = true;
                const btn = ui.el('shutter-btn');
                btn.style.transform = 'scale(0.8)';

                // Countdown
                const cd = ui.el('countdown');
                cd.style.opacity = 1;
                for (let i = 3; i > 0; i--) {
                    cd.innerText = i;
                    await new Promise(r => setTimeout(r, 1000));
                }
                cd.style.opacity = 0;

                // Burst or Single
                const shots = CONFIG.burst ? 3 : 1;
                
                for(let i=0; i<shots; i++) {
                    await app.captureFrame();
                    if(i < shots-1) await new Promise(r => setTimeout(r, 800));
                }

                STATE.isCapturing = false;
                btn.style.transform = 'scale(1)';
            },

            captureFrame: async () => {
                // 1. TRUE FLASH LOGIC (White Screen)
                if (STATE.flashOn) {
                    document.body.classList.add('flash-active');
                    await new Promise(r => setTimeout(r, 150)); // Light up the face
                }

                // 2. Capture Logic
                const vid = ui.el('camera-feed');
                const canvas = ui.el('proc-canvas');
                const ctx = canvas.getContext('2d');

                // Set canvas size to video native
                canvas.width = vid.videoWidth;
                canvas.height = vid.videoHeight;

                ctx.save();
                // Apply Mirroring
                if (CONFIG.mirror && STATE.facingMode === 'user') {
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                }
                // Apply Filter
                if (STATE.filter !== 'none') {
                    ctx.filter = STATE.filter;
                }
                ctx.drawImage(vid, 0, 0);
                ctx.restore();

                // 3. Reset Flash
                if (STATE.flashOn) {
                    document.body.classList.remove('flash-active');
                    const fx = ui.el('flash-fx');
                    fx.style.animation = 'none';
                    fx.offsetHeight; /* Trigger Reflow */
                    fx.style.animation = 'flashBang 0.5s ease-out';
                }

                // 4. Sound (Optional Oscillator)
                if (CONFIG.sound && window.AudioContext) {
                    // Simple beep
                    const actx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = actx.createOscillator();
                    const gain = actx.createGain();
                    osc.connect(gain);
                    gain.connect(actx.destination);
                    osc.frequency.value = 800;
                    gain.gain.exponentialRampToValueAtTime(0.00001, actx.currentTime + 0.1);
                    osc.start();
                    osc.stop(actx.currentTime + 0.1);
                }

                // 5. Save/Export
                const format = CONFIG.hq ? 'image/png' : 'image/jpeg';
                const quality = CONFIG.hq ? 1.0 : 0.9;
                
                // Convert to data URL
                const dataURL = canvas.toDataURL(format, quality);
                
                // Add to Gallery System
                gallery.add(dataURL);
            }
        };

        const gallery = {
            items: [],
            add: (url) => {
                gallery.items.push(url);
                // Trigger download immediately for simple UX
                const a = document.createElement('a');
                a.href = url;
                a.download = `studio_shot_${Date.now()}.` + (CONFIG.hq ? 'png' : 'jpg');
                a.click();
            },
            open: () => {
                // For this single file version, we use native file picker as a gallery placeholder
                // or just alert instructions
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.click();
            },
            clear: () => {
                if(confirm("Clear local cache and reset settings?")) {
                    location.reload();
                }
            }
        };

        // Initialize UI
        ui.initFilters();

        // Listen for orientation change to handle specific layout tweaks if needed
        window.addEventListener('resize', () => {
            // Recalculate 100vh fix if needed
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

    </script>
</body>
</html>
