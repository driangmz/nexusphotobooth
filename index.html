<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoBooth AI | Smart Photo System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --bg: #0f1014;
            --surface: #1e2129;
            --text: #ffffff;
            --accent: #fd79a8;
            --font-main: 'Inter', system-ui, sans-serif;
        }

        [data-theme="light"] {
            --primary: #5f27cd;
            --secondary: #00d2d3;
            --bg: #f5f6fa;
            --surface: #ffffff;
            --text: #2d3436;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            font-family: var(--font-main);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
        }

        /* --- LEFT SIDEBAR: CONTROLS --- */
        .sidebar {
            background: var(--surface);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .branding { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .branding span { color: var(--secondary); }

        .control-group { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
        [data-theme="light"] .control-group { background: rgba(0,0,0,0.05); }
        
        h3 { margin: 0 0 10px 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        button {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            color: var(--text);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        button.active { background: var(--primary); box-shadow: 0 0 15px var(--primary); }

        /* --- CENTER: STAGE --- */
        .stage {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .viewport {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 4/3;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 4px solid var(--surface);
        }

        video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror */
        }

        /* Overlays */
        .overlay-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 10;
            border: 0px solid transparent;
            transition: border 0.3s;
        }
        
        /* Simulated Face Tracking UI */
        .face-tracker {
            position: absolute;
            top: 50%; left: 50%;
            width: 150px; height: 150px;
            border: 2px dashed var(--secondary);
            border-radius: 20px;
            transform: translate(-50%, -50%);
            opacity: 0.5;
            transition: top 2s, left 2s; /* Lazy follow effect */
        }
        .face-tracker::after { content: 'FOCUS LOCKED'; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--secondary); background: black; padding: 2px 5px; }

        /* Countdown */
        .countdown {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 20;
            display: none;
        }

        /* --- RIGHT SIDEBAR: MASCOT & GALLERY --- */
        .info-panel {
            background: var(--surface);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .mascot-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg);
            border-radius: 15px;
            border: 1px solid var(--primary);
        }

        .mascot-avatar { font-size: 3rem; animation: bounce 2s infinite; display: inline-block; }
        .mascot-bubble { 
            background: var(--surface); padding: 10px; border-radius: 10px; 
            margin-top: 10px; font-size: 0.9rem; border-left: 3px solid var(--accent);
            min-height: 60px; display: flex; align-items: center; justify-content: center;
        }

        .stats { font-size: 0.8rem; opacity: 0.7; margin-top: auto; }
        
        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 20px; text-align: center; max-width: 500px; width: 90%; }
        .modal img { max-width: 100%; border-radius: 10px; margin-bottom: 20px; }
        #qrcode { margin: 20px auto; display: flex; justify-content: center; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }

        .flash-screen { position: fixed; inset: 0; background: white; z-index: 99; pointer-events: none; opacity: 0; }

        /* Responsive */
        @media(max-width: 900px) {
            body { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
            .sidebar, .info-panel { order: 2; }
            .stage { order: 1; }
        }
    </style>
</head>
<body>

    <div class="flash-screen" id="flash"></div>

    <div class="sidebar">
        <div class="branding">ðŸ“¸ NeoBooth<span>AI</span></div>
        
        <div class="control-group">
            <h3>Mode</h3>
            <div class="btn-grid">
                <button class="mode-btn active" data-mode="single">Single</button>
                <button class="mode-btn" data-mode="burst">Burst</button>
                <button class="mode-btn" data-mode="collage">Collage</button>
            </div>
        </div>

        <div class="control-group">
            <h3>Filters</h3>
            <select id="filterSelect" style="width: 100%; padding: 10px; border-radius: 8px;">
                <option value="none">Normal</option>
                <option value="grayscale(100%) contrast(1.2)">Noir</option>
                <option value="sepia(100%)">Vintage</option>
                <option value="hue-rotate(90deg) contrast(1.5)">Cyber</option>
                <option value="saturate(200%) brightness(1.1)">Pop</option>
                <option value="blur(2px) brightness(1.2)">Dreamy</option>
            </select>
        </div>

        <div class="control-group">
            <h3>Accessibility</h3>
            <div class="btn-grid">
                <button id="toggleVoice">ðŸ”Š Voice</button>
                <button id="toggleTheme">ðŸŒ— Theme</button>
            </div>
        </div>

        <div class="control-group">
            <h3>Stickers</h3>
            <div class="btn-grid">
                <button onclick="addSticker('ðŸ˜Ž')">ðŸ˜Ž</button>
                <button onclick="addSticker('ðŸ‘‘')">ðŸ‘‘</button>
                <button onclick="addSticker('ðŸ”¥')">ðŸ”¥</button>
                <button onclick="addSticker('ðŸŽ‰')">ðŸŽ‰</button>
            </div>
            <button onclick="clearStickers()" style="width:100%; margin-top:5px; color: #ff7675;">Clear All</button>
        </div>
    </div>

    <div class="stage">
        <div class="viewport" id="viewport">
            <video id="video" autoplay playsinline></video>
            <div class="overlay-layer" id="overlay">
                <div class="face-tracker"></div>
            </div>
            <div class="countdown" id="countdownDisplay">3</div>
        </div>
        
        <button id="snapBtn" style="margin-top: 20px; width: 80px; height: 80px; border-radius: 50%; background: #ff4757; border: 4px solid white; box-shadow: 0 0 20px #ff4757;"></button>
    </div>

    <div class="info-panel">
        <div class="mascot-container">
            <div class="mascot-avatar" id="mascotAvatar">ðŸ¤–</div>
            <div class="mascot-bubble" id="mascotText">Hello! I'm SnapBot. Ready to take some awesome photos?</div>
        </div>

        <div class="control-group">
            <h3>Session Stats</h3>
            <div id="statsBox">
                Photos taken: <span id="photoCount">0</span><br>
                Favorite Mode: <span id="favMode">-</span>
            </div>
        </div>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333;">
            <small style="display:block; color: gray;">System v2.4.0</small>
            <a href="#" onclick="alert('Version 2.4.0 Updates:\n- Added Voice Guidance\n- New Cyber Filter\n- Faster QR Generation')" style="color: var(--secondary); font-size: 0.8rem;">View Changelog</a>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2>Great Shot!</h2>
            <div id="resultContainer"></div> <div id="qrcode"></div>
            <p style="font-size: 0.8rem; color: gray;">Scan to share on mobile</p>
            <div class="btn-grid">
                <button onclick="downloadImage()">Download</button>
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const state = {
            mode: 'single',
            voiceEnabled: false,
            photoCount: 0,
            stickers: [],
            theme: 'dark'
        };

        // --- DOM ELEMENTS ---
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const snapBtn = document.getElementById('snapBtn');
        const mascotText = document.getElementById('mascotText');
        const mascotAvatar = document.getElementById('mascotAvatar');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const filterSelect = document.getElementById('filterSelect');
        const resultModal = document.getElementById('resultModal');
        const resultContainer = document.getElementById('resultContainer');
        const qrContainer = document.getElementById('qrcode');
        
        // Canvas for processing
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // --- INITIALIZATION ---
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false });
                video.srcObject = stream;
                speak("Camera system online. Please adjust your lighting.");
            } catch (e) {
                updateMascot("ðŸ˜µ", "Oh no! I can't find your camera.");
            }
        }

        // --- MASCOT & VOICE SYSTEM ---
        function updateMascot(emoji, text) {
            mascotAvatar.innerText = emoji;
            mascotText.innerText = text;
            speak(text);
        }

        function speak(text) {
            if (!state.voiceEnabled) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.1;
            utterance.pitch = 1.2;
            window.speechSynthesis.speak(utterance);
        }

        // --- UI INTERACTIONS ---
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.mode = e.target.dataset.mode;
                updateMascot("âš™ï¸", `Switched to ${state.mode} mode.`);
            });
        });

        filterSelect.addEventListener('change', (e) => {
            video.style.filter = e.target.value;
            updateMascot("ðŸŽ¨", "Nice filter choice!");
        });

        document.getElementById('toggleVoice').addEventListener('click', () => {
            state.voiceEnabled = !state.voiceEnabled;
            updateMascot(state.voiceEnabled ? "ðŸ”Š" : "ðŸ”‡", `Voice guidance ${state.voiceEnabled ? 'enabled' : 'disabled'}.`);
        });

        document.getElementById('toggleTheme').addEventListener('click', () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.theme);
        });

        // --- STICKER SYSTEM ---
        function addSticker(emoji) {
            // Random position near center
            const x = 30 + Math.random() * 40; 
            const y = 30 + Math.random() * 40;
            state.stickers.push({ emoji, x, y });
            renderStickers();
        }

        function clearStickers() {
            state.stickers = [];
            renderStickers();
        }

        function renderStickers() {
            // Remove old stickers from DOM overlay
            const old = overlay.querySelectorAll('.sticker-dom');
            old.forEach(el => el.remove());

            // Add new ones
            state.stickers.forEach(s => {
                const el = document.createElement('div');
                el.className = 'sticker-dom';
                el.innerText = s.emoji;
                el.style.position = 'absolute';
                el.style.left = s.x + '%';
                el.style.top = s.y + '%';
                el.style.fontSize = '3rem';
                el.style.textShadow = '0 5px 10px rgba(0,0,0,0.5)';
                overlay.appendChild(el);
            });
        }

        // --- CAPTURE LOGIC ---
        snapBtn.addEventListener('click', startCountdown);

        function startCountdown() {
            let count = 3;
            countdownDisplay.style.display = 'block';
            snapBtn.disabled = true;
            
            updateMascot("ðŸ“¸", "Get ready! Strike a pose!");

            const timer = setInterval(() => {
                countdownDisplay.innerText = count;
                speak(count.toString());
                if (count === 0) {
                    clearInterval(timer);
                    countdownDisplay.style.display = 'none';
                    triggerCapture();
                }
                count--;
            }, 1000);
        }

        function triggerCapture() {
            // Flash effect
            const flash = document.getElementById('flash');
            flash.style.animation = 'flash 0.5s';
            setTimeout(() => flash.style.animation = '', 500);

            // Audio Click
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 800;
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(0.1);

            if (state.mode === 'collage') {
                processCollage();
            } else {
                processSingleShot();
            }
            
            updateStats();
        }

        function captureFrameToCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Filters
            ctx.filter = getComputedStyle(video).filter;
            
            // Mirror & Draw Video
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

            // Draw Stickers
            state.stickers.forEach(s => {
                ctx.font = '100px serif';
                // Calculate position relative to canvas size (mirroring x)
                const xPos = canvas.width - (s.x / 100 * canvas.width); 
                const yPos = s.y / 100 * canvas.height;
                ctx.fillText(s.emoji, xPos - 50, yPos + 35);
            });

            return canvas.toDataURL('image/png');
        }

        function processSingleShot() {
            const dataURL = captureFrameToCanvas();
            showResult(dataURL);
            updateMascot("âœ¨", "Lookin' good! Do you want to save this?");
        }

        function processCollage() {
            // Simplified collage logic: Take 1 shot, replicate it 4 times in a grid
            // In a real app, this would loop capture 4 times.
            const rawFrame = captureFrameToCanvas();
            const img = new Image();
            img.src = rawFrame;
            img.onload = () => {
                const w = canvas.width;
                const h = canvas.height;
                // Resize canvas for 2x2 grid
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = w;
                finalCanvas.height = h;
                const fCtx = finalCanvas.getContext('2d');
                
                // Draw 4 times
                fCtx.drawImage(img, 0, 0, w/2, h/2);
                fCtx.drawImage(img, w/2, 0, w/2, h/2);
                fCtx.drawImage(img, 0, h/2, w/2, h/2);
                fCtx.drawImage(img, w/2, h/2, w/2, h/2);

                // Add border
                fCtx.strokeStyle = "white";
                fCtx.lineWidth = 20;
                fCtx.strokeRect(0,0,w,h);
                fCtx.moveTo(w/2, 0); fCtx.lineTo(w/2, h);
                fCtx.moveTo(0, h/2); fCtx.lineTo(w, h/2);
                fCtx.stroke();

                showResult(finalCanvas.toDataURL('image/png'));
                updateMascot("ðŸ–¼ï¸", "Collage complete!");
            }
        }

        // --- RESULTS & SHARING ---
        function showResult(dataUrl) {
            resultContainer.innerHTML = '';
            const img = document.createElement('img');
            img.src = dataUrl;
            img.id = "finalImage";
            resultContainer.appendChild(img);
            
            // Generate QR
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: "https://example.com/share/" + Date.now(), // Simulated link
                width: 100,
                height: 100
            });

            resultModal.style.display = 'flex';
            snapBtn.disabled = false;
        }

        function closeModal() {
            resultModal.style.display = 'none';
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `neobooth_${Date.now()}.png`;
            link.href = document.getElementById('finalImage').src;
            link.click();
            updateMascot("ðŸ’¾", "Saved to your device!");
        }

        // --- ANALYTICS ---
        function updateStats() {
            state.photoCount++;
            localStorage.setItem('neobooth_count', state.photoCount);
            document.getElementById('photoCount').innerText = state.photoCount;
            document.getElementById('favMode').innerText = state.mode.toUpperCase();
        }

        // Load stats on start
        const savedCount = localStorage.getItem('neobooth_count');
        if (savedCount) state.photoCount = parseInt(savedCount);
        document.getElementById('photoCount').innerText = state.photoCount;

        // Start
        initCamera();
        
        // Random Face Tracking Movement (Simulation)
        setInterval(() => {
            const tracker = document.querySelector('.face-tracker');
            const top = 30 + Math.random() * 40;
            const left = 30 + Math.random() * 40;
            tracker.style.top = top + "%";
            tracker.style.left = left + "%";
        }, 3000);

    </script>
</body>
</html>
