<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PRO Studio Booth | Ultimate Edition</title>
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Palette */
            --c-primary: #00f2ea;
            --c-primary-dim: rgba(0, 242, 234, 0.15);
            --c-secondary: #ff0050;
            --c-secondary-dim: rgba(255, 0, 80, 0.15);
            --c-accent: #ffee00;
            --c-bg: #000000;
            --c-surface: #121212;
            --c-surface-2: #1e1e1e;
            --c-text: #ffffff;
            --c-text-muted: #888888;
            --c-border: rgba(255, 255, 255, 0.1);

            /* Typography */
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", "Courier New", monospace;

            /* Spacing & Layout */
            --header-h: 60px;
            --control-h: 280px; /* Base height for controls */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            /* Calculated in JS */
            --vh: 1vh; 
        }

        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden; /* Prevent scroll bounce */
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            position: fixed; /* Lock viewport */
        }

        /* =========================================
           2. ANIMATIONS
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255,0,80, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,80, 0); } }
        @keyframes flashBang { 0% { background: white; opacity: 1; } 100% { background: white; opacity: 0; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes scanline { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* =========================================
           3. APP LAYOUT STRUCTURE
           ========================================= */
        #app-root {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 100%;
        }

        /* --- HEADER --- */
        #top-bar {
            height: var(--header-h);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            padding-top: var(--safe-top);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid var(--c-border);
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }
        .brand-dot { width: 12px; height: 12px; background: var(--c-primary); border-radius: 50%; box-shadow: 0 0 10px var(--c-primary); }

        .top-actions { display: flex; gap: 15px; }
        
        .icon-btn {
            background: transparent; border: none; color: var(--c-text);
            cursor: pointer; padding: 8px; border-radius: 50%;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- STAGE (VIEWFINDER) --- */
        #stage {
            flex: 1;
            position: relative;
            background: #080808;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            width: 100%;
        }

        .viewfinder-box {
            position: relative;
            width: 100%;
            height: 100%;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        video#live-feed {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Default */
            transform: scaleX(-1); /* Mirror default */
        }
        
        /* Mirroring Classes */
        .no-mirror video#live-feed { transform: scaleX(1); }
        .fit-cover video#live-feed { object-fit: cover; }

        /* OVERLAYS ON VIDEO */
        .vf-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .grid-lines {
            width: 100%; height: 100%; position: absolute; opacity: 0; transition: opacity 0.3s;
        }
        .grid-lines.active { opacity: 1; }
        .gl-h { position: absolute; width: 100%; height: 1px; background: rgba(255,255,255,0.3); left: 0; }
        .gl-v { position: absolute; height: 100%; width: 1px; background: rgba(255,255,255,0.3); top: 0; }

        .flash-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; opacity: 0; z-index: 100; pointer-events: none;
        }

        /* HUD Elements */
        .hud-top-right {
            position: absolute; top: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .rec-tag {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,0,80,0.5);
            color: #fff; padding: 4px 12px; border-radius: 4px;
            font-family: var(--font-mono); font-size: 0.75rem;
            display: flex; align-items: center; gap: 8px;
        }
        .rec-dot { width: 8px; height: 8px; background: #ff0050; border-radius: 50%; animation: pulse 2s infinite; }

        .hud-bottom-left {
            position: absolute; bottom: 20px; left: 20px;
            font-family: var(--font-mono); font-size: 0.7rem; color: var(--c-primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .histogram-container {
            width: 100px; height: 50px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--c-border); margin-top: 5px;
        }
        #histogram-canvas { width: 100%; height: 100%; }

        .audio-vis-container {
            width: 100px; height: 30px; display: flex; align-items: flex-end; gap: 2px;
            margin-top: 5px; opacity: 0.8;
        }
        .vis-bar { flex: 1; background: var(--c-primary); border-radius: 2px 2px 0 0; transition: height 0.05s; }

        #countdown-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15vw; font-weight: 900; color: #fff; text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0;
        }

        /* --- CONTROL DECK (BOTTOM) --- */
        #control-deck {
            background: var(--c-surface);
            border-top: 1px solid var(--c-border);
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 50;
            flex-shrink: 0;
            /* Adaptive height */
            min-height: 200px;
        }

        /* Filter Scroll */
        .filter-ribbon {
            width: 100%;
            overflow-x: auto;
            display: flex;
            gap: 12px;
            padding-bottom: 5px;
            scrollbar-width: none; /* Firefox */
        }
        .filter-ribbon::-webkit-scrollbar { display: none; }
        
        .filter-chip {
            flex: 0 0 auto;
            background: #000;
            border: 1px solid var(--c-border);
            color: #aaa;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip.active {
            border-color: var(--c-primary);
            color: var(--c-primary);
            background: var(--c-primary-dim);
            font-weight: 600;
        }

        /* Main Controls Row */
        .main-controls {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
        }

        .side-ctrl {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ctrl-btn-group {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 4px;
            display: flex;
        }
        
        .c-btn {
            background: transparent; border: none; color: #888;
            padding: 8px 12px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; border-radius: 8px; transition: 0.2s;
        }
        .c-btn.active { background: #333; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Shutter Button */
        .shutter-wrapper {
            position: relative;
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        
        #btn-shutter {
            width: 72px; height: 72px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.2);
            background: linear-gradient(135deg, #ff0050, #b30038);
            cursor: pointer;
            position: relative;
            z-index: 2;
            transition: transform 0.1s;
            box-shadow: 0 10px 20px rgba(255,0,80,0.3);
        }
        #btn-shutter:active { transform: scale(0.95); }
        
        /* Flash Toggle connected to shutter */
        .flash-toggle-mini {
            position: absolute; top: -10px; right: -10px;
            width: 32px; height: 32px; background: #333;
            border: 2px solid #000; border-radius: 50%;
            color: #aaa; display: flex; align-items: center; justify-content: center;
            z-index: 3; font-size: 0.8rem; cursor: pointer;
        }
        .flash-toggle-mini.active { background: #fff; color: #000; }

        /* Gallery Preview Pill */
        .gallery-pill {
            margin-top: 5px;
            background: #222;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            cursor: pointer;
        }
        .gallery-pill:active { background: #333; }
        .gallery-thumbs { display: flex; gap: 5px; }
        .g-thumb-mini { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; background: #000; }

        /* =========================================
           4. MODALS & DRAWERS
           ========================================= */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: all; }

        .modal-card {
            background: #1a1a1a; width: 90%; max-width: 500px;
            border-radius: 20px; border: 1px solid #333;
            transform: scale(0.9); transition: transform 0.3s;
            max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-backdrop.open .modal-card { transform: scale(1); }

        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-foot { padding: 20px; border-top: 1px solid #333; text-align: right; }

        /* Fullscreen Gallery */
        #gallery-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #gallery-viewer.open { transform: translateY(0); }

        .gv-header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; padding-top: var(--safe-top); background: #111;
        }
        .gv-grid {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
        }
        .gv-item {
            aspect-ratio: 1; background: #222; border-radius: 8px; overflow: hidden; position: relative;
        }
        .gv-item img { width: 100%; height: 100%; object-fit: cover; }
        .gv-actions {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 5px; display: flex; justify-content: flex-end;
        }

        /* Settings Rows */
        .st-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .st-label { font-size: 0.95rem; }
        .st-desc { font-size: 0.8rem; color: #666; display: block; margin-top: 4px; }
        
        /* Toggle Switch */
        .toggle-sw {
            position: relative; width: 44px; height: 24px;
        }
        .toggle-sw input { opacity: 0; width: 0; height: 0; }
        .ts-track {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .3s; border-radius: 34px;
        }
        .ts-track:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .ts-track { background-color: var(--c-primary); }
        input:checked + .ts-track:before { transform: translateX(20px); }

        /* Toast Notifications */
        #toast-container {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 9000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: rgba(20, 20, 20, 0.9); border: 1px solid var(--c-primary-dim);
            color: #fff; padding: 10px 20px; border-radius: 30px;
            font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out; display: flex; align-items: center; gap: 10px;
        }

        /* --- MEDIA QUERIES FOR LANDSCAPE/DESKTOP --- */
        @media (min-width: 768px) {
            #app-root {
                flex-direction: row;
            }
            #top-bar {
                width: 80px; height: 100%; flex-direction: column;
                padding: 20px 0; border-bottom: none; border-right: 1px solid var(--c-border);
            }
            .brand { writing-mode: vertical-rl; transform: rotate(180deg); }
            .top-actions { flex-direction: column; }
            
            #control-deck {
                width: 320px; height: 100%; border-top: none; border-left: 1px solid var(--c-border);
                overflow-y: auto; padding-bottom: 20px;
            }
            
            .main-controls { display: flex; flex-direction: column; gap: 30px; }
            .side-ctrl { width: 100%; align-items: flex-start; }
            .shutter-wrapper { margin: 20px 0; }
            
            .gv-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        }

    </style>
</head>
<body>

    <div id="app-root">
        
        <header id="top-bar">
            <div class="brand">
                <div class="brand-dot"></div>
                <span>STUDIO PRO</span>
            </div>
            <div class="top-actions">
                <button class="icon-btn" onclick="UI.toggleModal('settings')" title="Settings">
                    <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                </button>
                <button class="icon-btn" onclick="UI.toggleModal('info')" title="About">
                    <svg viewBox="0 0 24 24"><path d="M11,18h2v-2h-2V18z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8 s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z M12,6c-2.21,0-4,1.79-4,4h2c0-1.1,0.9-2,2-2s2,0.9,2,2c0,2-3,1.75-3,5h2c0-2.25,3-2.5,3-5 C16,7.79,14.21,6,12,6z"/></svg>
                </button>
            </div>
        </header>

        <main id="stage">
            <div class="viewfinder-box" id="vf-box">
                <video id="live-feed" autoplay playsinline muted></video>
                
                <div class="vf-overlay">
                    <div class="grid-lines" id="grid-lines">
                        <div class="gl-h" style="top:33%"></div>
                        <div class="gl-h" style="top:66%"></div>
                        <div class="gl-v" style="left:33%"></div>
                        <div class="gl-v" style="left:66%"></div>
                    </div>
                    
                    <div class="hud-top-right">
                        <div class="rec-tag"><div class="rec-dot"></div> REC</div>
                        <div class="rec-tag" style="background:transparent; border:none; color:var(--c-accent)">ISO AUTO</div>
                    </div>

                    <div class="hud-bottom-left">
                        <div>1080p 60fps</div>
                        <div class="histogram-container">
                            <canvas id="histogram-canvas"></canvas>
                        </div>
                        <div class="audio-vis-container" id="audio-vis">
                            </div>
                    </div>

                    <div id="countdown-overlay">3</div>
                    <div class="flash-layer" id="flash-layer"></div>
                </div>
            </div>
        </main>

        <section id="control-deck">
            
            <div class="filter-ribbon" id="filter-list">
                </div>

            <div class="main-controls">
                
                <div class="side-ctrl">
                    <span class="st-desc">LENS</span>
                    <div class="ctrl-btn-group">
                        <button class="c-btn active" onclick="Camera.switchLens('user')">Front</button>
                        <button class="c-btn" onclick="Camera.switchLens('environment')">Rear</button>
                    </div>
                    
                    <span class="st-desc" style="margin-top:10px">MODE</span>
                    <div class="ctrl-btn-group">
                        <button class="c-btn active" id="mode-single" onclick="Camera.setMode('single')">1x</button>
                        <button class="c-btn" id="mode-burst" onclick="Camera.setMode('burst')">3x</button>
                    </div>
                </div>

                <div class="shutter-wrapper">
                    <button id="btn-shutter" onclick="Camera.captureSequence()"></button>
                    <button class="flash-toggle-mini active" id="btn-flash" onclick="Camera.toggleFlash()">⚡</button>
                </div>

                <div class="side-ctrl">
                    <span class="st-desc">RATIO</span>
                    <div class="ctrl-btn-group">
                        <button class="c-btn" onclick="UI.setRatio('4-3')">4:3</button>
                        <button class="c-btn active" onclick="UI.setRatio('16-9')">16:9</button>
                        <button class="c-btn" onclick="UI.setRatio('1-1')">1:1</button>
                    </div>

                    <div class="gallery-pill" onclick="Gallery.open()">
                        <span>Gallery</span>
                        <div class="gallery-thumbs" id="mini-thumbs"></div>
                    </div>
                </div>

            </div>
        </section>

    </div>

    <div id="modal-settings" class="modal-backdrop">
        <div class="modal-card">
            <div class="modal-head">
                <h3>Settings</h3>
                <button class="icon-btn" onclick="UI.toggleModal('settings')">✕</button>
            </div>
            <div class="modal-body">
                <div class="st-row">
                    <div>
                        <span class="st-label">Mirror Front Camera</span>
                        <span class="st-desc">Flip selfie video horizontally</span>
                    </div>
                    <label class="toggle-sw"><input type="checkbox" id="set-mirror" checked onchange="State.settings.mirror = this.checked; UI.updateVideoStyles()"><span class="ts-track"></span></label>
                </div>
                <div class="st-row">
                    <div>
                        <span class="st-label">Grid Overlay</span>
                        <span class="st-desc">Rule of thirds guide</span>
                    </div>
                    <label class="toggle-sw"><input type="checkbox" id="set-grid" onchange="UI.toggleGrid(this.checked)"><span class="ts-track"></span></label>
                </div>
                <div class="st-row">
                    <div>
                        <span class="st-label">Voice Commands</span>
                        <span class="st-desc">Say "Cheese" or "Snap" to capture</span>
                    </div>
                    <label class="toggle-sw"><input type="checkbox" id="set-voice" onchange="Voice.toggle(this.checked)"><span class="ts-track"></span></label>
                </div>
                <div class="st-row">
                    <div>
                        <span class="st-label">HD Export</span>
                        <span class="st-desc">Save as PNG (Larger files)</span>
                    </div>
                    <label class="toggle-sw"><input type="checkbox" id="set-hd" onchange="State.settings.hd = this.checked"><span class="ts-track"></span></label>
                </div>
                <div class="st-row">
                    <div>
                        <span class="st-label">Watermark</span>
                        <span class="st-desc">Add date and studio name</span>
                    </div>
                    <label class="toggle-sw"><input type="checkbox" id="set-watermark" onchange="State.settings.watermark = this.checked"><span class="ts-track"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-info" class="modal-backdrop">
        <div class="modal-card">
            <div class="modal-head"><h3>About Studio Pro</h3><button class="icon-btn" onclick="UI.toggleModal('info')">✕</button></div>
            <div class="modal-body">
                <p><strong>Version 1.0</strong></p>
                <p style="color:#888; font-size:0.9rem;">
                    About
Nexus Pro Photobooth is a modern, interactive photo experience designed to capture moments with style and simplicity. Built with a minimalist interface and customizable features, it offers users a seamless way to take, save, and share memories. The system emphasizes accessibility, creativity, and user-friendly design.

Terms of Use
- The Nexus Pro Photobooth is provided for educational and demonstration purposes only.  
- Users agree to use the system responsibly and refrain from any misuse that could compromise data integrity or user experience.  
- The service is not intended for commercial deployment without further development and compliance checks.  

Data Privacy
- Nexus Pro Photobooth respects user privacy.  
- No personal data is permanently stored or shared without consent.  
- Temporary session data may be used to enable features such as previews, downloads, or sharing.  
- Users are encouraged to clear sessions after use to maintain privacy.  

Data Handling
- Images captured are processed locally within the system.  
- Optional saving or exporting features are controlled entirely by the user.  
- No third-party tracking or analytics are embedded in the educational version.  

Credits
Created with love by @ianny
For educational purposes only.
                </p>
                <br>
                <p style="font-size:0.8rem; color:#666">© 2026 Studio Pro. All operations are local.</p>
            </div>
        </div>
    </div>

    <div id="gallery-viewer">
        <div class="gv-header">
            <h3>Gallery <span style="font-size:0.8rem; color:#666" id="gv-count">(0)</span></h3>
            <div style="display:flex; gap:10px;">
                <button class="c-btn" style="border:1px solid #333" onclick="Gallery.clear()">Delete All</button>
                <button class="c-btn active" onclick="Gallery.close()">Close</button>
            </div>
        </div>
        <div class="gv-grid" id="gv-grid">
            </div>
    </div>

    <div id="toast-container"></div>

    <canvas id="process-canvas" style="display:none;"></canvas>

    <script>
        /**
         * =========================================
         * STUDIO PRO CORE JAVASCRIPT
         * =========================================
         */

        /* --- 1. STATE MANAGEMENT --- */
        const State = {
            stream: null,
            timer: 3,
            isCapturing: false,
            filter: 'none',
            mode: 'single', // single | burst
            lens: 'user', // user | environment
            ratio: 1.777, // 16:9
            photos: [],
            settings: {
                mirror: true,
                flash: true,
                grid: false,
                hd: false,
                voice: false,
                watermark: false
            }
        };

        const FILTERS = [
            { id: 'none', name: 'Normal', css: 'none' },
            { id: 'bw', name: 'Mono', css: 'grayscale(100%) contrast(1.2)' },
            { id: 'warm', name: 'Warm', css: 'sepia(0.3) saturate(1.4)' },
            { id: 'cool', name: 'Arctic', css: 'hue-rotate(180deg) saturate(0.6)' },
            { id: 'vivid', name: 'Vivid', css: 'saturate(2.0) contrast(1.1)' },
            { id: 'vintage', name: '1985', css: 'sepia(0.5) contrast(0.9) brightness(1.1)' },
            { id: 'cyber', name: 'Cyber', css: 'hue-rotate(-20deg) saturate(2) contrast(1.2)' },
            { id: 'noir', name: 'Noir', css: 'grayscale(100%) contrast(2.0) brightness(0.8)' }
        ];

        /* --- 2. UI UTILITIES --- */
        const UI = {
            init: () => {
                // Set viewport height for mobile fix
                UI.fixViewport();
                window.addEventListener('resize', UI.fixViewport);

                // Render Filters
                const ribbon = document.getElementById('filter-list');
                FILTERS.forEach((f, i) => {
                    const chip = document.createElement('div');
                    chip.className = `filter-chip ${i===0?'active':''}`;
                    chip.innerText = f.name;
                    chip.onclick = () => {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        Camera.applyFilter(f.css);
                    };
                    ribbon.appendChild(chip);
                });

                // Init Visualizer Bars
                const visContainer = document.getElementById('audio-vis');
                for(let i=0; i<8; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'vis-bar';
                    bar.style.height = '10%';
                    visContainer.appendChild(bar);
                }
            },

            fixViewport: () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            },

            toggleModal: (id) => {
                const el = document.getElementById(`modal-${id}`);
                if (el.classList.contains('open')) el.classList.remove('open');
                else el.classList.add('open');
            },

            toggleGrid: (active) => {
                document.getElementById('grid-lines').classList.toggle('active', active);
            },

            updateVideoStyles: () => {
                const vid = document.getElementById('live-feed');
                const box = document.getElementById('vf-box');
                
                // Mirroring
                if (State.settings.mirror && State.lens === 'user') box.classList.remove('no-mirror');
                else box.classList.add('no-mirror');
            },

            setRatio: (ratioStr) => {
                const vid = document.getElementById('live-feed');
                if(ratioStr === '1-1') {
                    State.ratio = 1;
                    vid.style.objectFit = 'cover';
                } else if(ratioStr === '4-3') {
                    State.ratio = 1.33;
                    vid.style.objectFit = 'cover';
                } else {
                    State.ratio = 1.77; // 16:9
                    vid.style.objectFit = 'contain';
                }
                
                // Visual update for buttons
                document.querySelectorAll('.side-ctrl .c-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                
                Toast.show(`Aspect Ratio: ${ratioStr}`);
            },

            toast: (msg) => Toast.show(msg)
        };

        const Toast = {
            show: (msg) => {
                const container = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerHTML = `<span style="color:var(--c-primary)">●</span> ${msg}`;
                container.appendChild(t);
                setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.transform = 'translateY(-20px)';
                    setTimeout(() => t.remove(), 300);
                }, 3000);
            }
        };

        /* --- 3. CAMERA ENGINE --- */
        const Camera = {
            videoEl: document.getElementById('live-feed'),
            canvasEl: document.getElementById('process-canvas'),
            
            init: async () => {
                try {
                    await Camera.startStream();
                    Analysis.startLoop();
                    AudioSys.init();
                    UI.toast("System Ready");
                } catch (e) {
                    alert("Camera Error: " + e.message);
                }
            },

            startStream: async () => {
                if(State.stream) State.stream.getTracks().forEach(t => t.stop());

                const constraints = {
                    audio: false,
                    video: {
                        facingMode: State.lens,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                State.stream = await navigator.mediaDevices.getUserMedia(constraints);
                Camera.videoEl.srcObject = State.stream;
                
                // Apply current mirror setting logic
                UI.updateVideoStyles();
            },

            switchLens: async (mode) => {
                if(mode === State.lens) return;
                State.lens = mode;
                
                // Update buttons
                const btns = document.querySelectorAll('.side-ctrl:first-child .c-btn');
                btns.forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                
                await Camera.startStream();
                UI.toast(`Switched to ${mode === 'user' ? 'Front' : 'Rear'} Camera`);
            },

            setMode: (mode) => {
                State.mode = mode;
                document.getElementById('mode-single').classList.toggle('active', mode === 'single');
                document.getElementById('mode-burst').classList.toggle('active', mode === 'burst');
                UI.toast(`Mode: ${mode.toUpperCase()}`);
            },

            applyFilter: (css) => {
                State.filter = css;
                Camera.videoEl.style.filter = css;
            },

            toggleFlash: () => {
                State.settings.flash = !State.settings.flash;
                document.getElementById('btn-flash').classList.toggle('active', State.settings.flash);
                UI.toast(`Flash ${State.settings.flash ? 'ON' : 'OFF'}`);
            },

            captureSequence: async () => {
                if(State.isCapturing) return;
                State.isCapturing = true;

                const count = State.mode === 'single' ? 1 : 3;
                
                // Countdown
                if(State.timer > 0) await Camera.runCountdown();

                for(let i=0; i<count; i++) {
                    await Camera.takePhoto();
                    if(i < count-1) await new Promise(r => setTimeout(r, 800));
                }

                State.isCapturing = false;
            },

            runCountdown: () => new Promise(resolve => {
                const el = document.getElementById('countdown-overlay');
                let c = State.timer;
                el.innerText = c;
                el.style.opacity = '1';
                
                const int = setInterval(() => {
                    c--;
                    if(c > 0) {
                        el.innerText = c;
                    } else {
                        clearInterval(int);
                        el.style.opacity = '0';
                        resolve();
                    }
                }, 1000);
            }),

            takePhoto: async () => {
                // 1. Flash Effect
                if(State.settings.flash) {
                    const fl = document.getElementById('flash-layer');
                    fl.style.animation = 'none';
                    fl.offsetHeight; /* trigger reflow */
                    fl.style.animation = 'flashBang 0.2s ease-out';
                }

                // 2. Capture Frame
                const ctx = Camera.canvasEl.getContext('2d');
                const vW = Camera.videoEl.videoWidth;
                const vH = Camera.videoEl.videoHeight;

                // Crop Logic
                let sW, sH, sX, sY;
                const vRatio = vW / vH;
                const targetRatio = State.ratio;

                if (vRatio > targetRatio) {
                    sH = vH; sW = vH * targetRatio; sX = (vW - sW) / 2; sY = 0;
                } else {
                    sW = vW; sH = vW / targetRatio; sX = 0; sY = (vH - sH) / 2;
                }

                Camera.canvasEl.width = sW;
                Camera.canvasEl.height = sH;

                ctx.save();
                
                // Mirror if needed
                if(State.settings.mirror && State.lens === 'user') {
                    ctx.translate(sW, 0);
                    ctx.scale(-1, 1);
                }

                // Filters
                if(State.filter !== 'none') ctx.filter = State.filter;

                ctx.drawImage(Camera.videoEl, sX, sY, sW, sH, 0, 0, sW, sH);
                ctx.restore();

                // Watermark
                if(State.settings.watermark) {
                    ctx.font = `bold ${sH*0.04}px monospace`;
                    ctx.fillStyle = "#ff0050";
                    ctx.textAlign = "right";
                    ctx.fillText(new Date().toLocaleTimeString(), sW - 20, sH - 20);
                }

                // 3. Save
                const quality = State.settings.hd ? 1.0 : 0.85;
                const type = State.settings.hd ? 'image/png' : 'image/jpeg';
                const data = Camera.canvasEl.toDataURL(type, quality);
                
                Gallery.add(data);
            }
        };

        /* --- 4. GALLERY SYSTEM --- */
        const Gallery = {
            add: (data) => {
                State.photos.unshift({ id: Date.now(), data });
                Gallery.updateThumbs();
                UI.toast("Photo Saved");
            },

            updateThumbs: () => {
                const c = document.getElementById('mini-thumbs');
                c.innerHTML = '';
                // Show last 3
                State.photos.slice(0,3).forEach(p => {
                    const img = document.createElement('img');
                    img.src = p.data;
                    img.className = 'g-thumb-mini';
                    c.appendChild(img);
                });
                
                // Update full viewer count
                document.getElementById('gv-count').innerText = `(${State.photos.length})`;
            },

            open: () => {
                const viewer = document.getElementById('gallery-viewer');
                const grid = document.getElementById('gv-grid');
                grid.innerHTML = '';
                
                State.photos.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'gv-item';
                    item.innerHTML = `
                        <img src="${p.data}">
                        <div class="gv-actions">
                            <button class="c-btn active" style="padding:4px 8px; font-size:0.6rem;" onclick="Gallery.download('${p.data}')">↓</button>
                        </div>
                    `;
                    grid.appendChild(item);
                });

                viewer.classList.add('open');
            },

            close: () => {
                document.getElementById('gallery-viewer').classList.remove('open');
            },

            clear: () => {
                if(confirm("Delete all photos?")) {
                    State.photos = [];
                    Gallery.updateThumbs();
                    Gallery.open(); // Refresh grid
                }
            },

            download: (data) => {
                const a = document.createElement('a');
                a.href = data;
                a.download = `studio_pro_${Date.now()}.png`;
                a.click();
            }
        };

        /* --- 5. AUDIO & VISUALIZATION (EXPANDED FEATURE) --- */
        const Analysis = {
            histCtx: document.getElementById('histogram-canvas').getContext('2d'),
            
            startLoop: () => {
                requestAnimationFrame(Analysis.loop);
            },

            loop: () => {
                if (Camera.videoEl.readyState === 4) {
                    Analysis.drawHistogram();
                    AudioSys.draw();
                }
                requestAnimationFrame(Analysis.loop);
            },

            drawHistogram: () => {
                // Simplified histogram: grab small center chunk of video
                // Drawing full HD histogram every frame is too heavy for JS
                const ctx = Analysis.histCtx;
                const w = 100, h = 50;
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                
                // Fake histogram animation for visual effect (Actual pixel analysis is heavy)
                // In a real pro app, we'd use WebGL. Here we simulate activity.
                const time = Date.now() / 1000;
                ctx.beginPath();
                ctx.moveTo(0, h);
                for(let i=0; i<w; i+=5) {
                    const val = Math.abs(Math.sin(i * 0.1 + time) * h * 0.8);
                    ctx.lineTo(i, h - val);
                }
                ctx.lineTo(w, h);
                ctx.fill();
            }
        };

        const AudioSys = {
            ctx: null,
            analyser: null,
            dataArray: null,
            
            init: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const source = AudioSys.ctx.createMediaStreamSource(stream);
                    AudioSys.analyser = AudioSys.ctx.createAnalyser();
                    AudioSys.analyser.fftSize = 32;
                    source.connect(AudioSys.analyser);
                    
                    const bufferLength = AudioSys.analyser.frequencyBinCount;
                    AudioSys.dataArray = new Uint8Array(bufferLength);
                } catch(e) {
                    console.log("Audio visualizer disabled (permissions)");
                }
            },

            draw: () => {
                if(!AudioSys.analyser) return;
                AudioSys.analyser.getByteFrequencyData(AudioSys.dataArray);
                
                const bars = document.querySelectorAll('.vis-bar');
                // We have 8 bars, 16 data points roughly
                for(let i=0; i<8; i++) {
                    const val = AudioSys.dataArray[i]; // 0-255
                    const pct = (val / 255) * 100;
                    if(bars[i]) bars[i].style.height = Math.max(10, pct) + '%';
                }
            }
        };

        /* --- 6. VOICE COMMANDS (EXPANDED FEATURE) --- */
        const Voice = {
            recognition: null,
            
            toggle: (active) => {
                if(!active) {
                    if(Voice.recognition) Voice.recognition.stop();
                    return;
                }

                if (!('webkitSpeechRecognition' in window)) {
                    alert("Voice control not supported in this browser.");
                    document.getElementById('set-voice').checked = false;
                    return;
                }

                Voice.recognition = new webkitSpeechRecognition();
                Voice.recognition.continuous = true;
                Voice.recognition.lang = 'en-US';
                Voice.recognition.interimResults = false;

                Voice.recognition.onresult = (event) => {
                    const last = event.results.length - 1;
                    const command = event.results[last][0].transcript.trim().toLowerCase();
                    
                    if(command.includes('snap') || command.includes('cheese') || command.includes('photo')) {
                        UI.toast(`Voice Command: "${command}"`);
                        Camera.captureSequence();
                    }
                };

                Voice.recognition.start();
                UI.toast("Listening for 'Snap' or 'Cheese'");
            }
        };

        // Boot
        window.addEventListener('load', () => {
            UI.init();
            Camera.init();
        });

    </script>
</body>
</html>

