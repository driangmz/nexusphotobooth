<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoBooth AI | Pro Master Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            /* --- ADVANCED THEME VARIABLES --- */
            --primary: #00f260; 
            --primary-dim: rgba(0, 242, 96, 0.2);
            --accent: #0575e6;
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 25, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #888888;
            --font-stack: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --radius-lg: 24px;
            --radius-sm: 12px;
            --shadow-glow: 0 0 20px rgba(0, 242, 96, 0.15);
        }

        /* --- THEME ENGINE --- */
        [data-theme="cyber"] { --primary: #00f260; --accent: #0575e6; }
        [data-theme="neon"] { --primary: #ff00ff; --accent: #00ffff; --shadow-glow: 0 0 25px rgba(255, 0, 255, 0.3); }
        [data-theme="gold"] { --primary: #ffd700; --accent: #f1c40f; --panel-bg: rgba(30, 30, 30, 0.85); }
        [data-theme="minimal"] { --primary: #ffffff; --accent: #888888; --bg-color: #111; --panel-bg: rgba(255,255,255,0.1); }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-stack); background-color: var(--bg-color); 
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            color: var(--text-main); margin: 0; height: 100dvh; 
            overflow: hidden; display: flex; flex-direction: column;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- LOADING SCREEN --- */
        #bootScreen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .loader-bar { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--primary); transition: width 1s ease-out; }

        /* --- RESPONSIVE GRID ARCHITECTURE --- */
        .app-layout { 
            display: grid; 
            grid-template-columns: 340px 1fr 380px; 
            grid-template-rows: 1fr;
            height: 100%; 
            padding: 20px; gap: 20px;
        }

        /* Portrait/Tablet Mode */
        body.portrait-mode .app-layout, 
        @media (max-width: 1100px) {
            .app-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                overflow-y: auto;
                padding: 15px;
            }
            /* Reorder for mobile flow */
            .sidebar-left { order: 2; height: auto; max-height: 400px; }
            .stage-center { order: 1; min-height: 60vh; }
            .sidebar-right { order: 3; height: auto; }
        }

        /* --- GLASSMOPHISM PANELS --- */
        .panel {
            background: var(--panel-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: var(--radius-lg);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow-y: auto;
            scrollbar-width: none; /* Hide scrollbar FF */
        }
        .panel::-webkit-scrollbar { display: none; }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; margin-bottom: 5px;
        }
        .panel-title { font-size: 0.9rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }

        /* --- ADVANCED CONTROLS --- */
        .control-group { display: flex; flex-direction: column; gap: 10px; }
        .group-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-top: 10px; }

        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; }
        
        .btn {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-main); padding: 12px; border-radius: var(--radius-sm);
            cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); border-color: var(--primary); }
        .btn.active { 
            background: var(--primary); color: #000; border-color: var(--primary); 
            box-shadow: var(--shadow-glow); 
        }
        .btn.danger { color: #ff4757; border-color: rgba(255, 71, 87, 0.3); }
        .btn.danger:hover { background: #ff4757; color: white; }

        /* --- SLIDERS --- */
        .slider-wrap { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600; }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; background: transparent; height: 20px; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary); margin-top: -6px; box-shadow: 0 0 10px var(--primary);
            transition: transform 0.2s;
        }
        input[type="range"]:active::-webkit-slider-thumb { transform: scale(1.3); }

        /* --- VIEWPORT & HUD --- */
        .stage-center { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .viewport-container {
            position: relative; width: 100%; aspect-ratio: 16/9; max-height: 80vh;
            background: #000; border-radius: 16px; overflow: hidden;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 20px 60px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
        }
        .viewport-container.square { aspect-ratio: 1/1; max-width: 65vh; }
        .viewport-container.portrait { aspect-ratio: 9/16; max-height: 85vh; }

        video, canvas { width: 100%; height: 100%; object-fit: contain; position: absolute; top:0; left:0; }
        video { transform: scaleX(-1); filter: contrast(1.1); } /* Default subtle enhancement */

        /* HUD Overlays */
        .hud-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0.8; }
        .hud-corner { position: absolute; width: 40px; height: 40px; border: 2px solid var(--primary); opacity: 0.5; transition: 0.3s; }
        .tl { top: 20px; left: 20px; border-right: 0; border-bottom: 0; }
        .tr { top: 20px; right: 20px; border-left: 0; border-bottom: 0; }
        .bl { bottom: 20px; left: 20px; border-right: 0; border-top: 0; }
        .br { bottom: 20px; right: 20px; border-left: 0; border-top: 0; }
        
        /* Histogram Simulation */
        .hud-histogram { 
            position: absolute; bottom: 20px; left: 20px; width: 100px; height: 40px; 
            display: flex; align-items: flex-end; gap: 2px; opacity: 0.6;
        }
        .hist-bar { flex: 1; background: var(--primary); animation: histAnim 0.5s infinite alternate; }

        /* Draggable Layers */
        .layer-interactive { position: absolute; inset: 0; z-index: 20; touch-action: none; overflow: hidden; }
        .sticker-el { 
            position: absolute; font-size: 3.5rem; cursor: grab; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.1s; user-select: none;
        }
        .sticker-el:active { cursor: grabbing; transform: scale(1.1); }

        /* --- TABS --- */
        .tab-group { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { 
            flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; 
            border-radius: 8px; color: var(--text-muted); transition: 0.3s; font-weight: 700; 
        }
        .tab.active { background: rgba(255,255,255,0.1); color: var(--text-main); }
        .tab-content { display: none; animation: slideIn 0.3s ease; }
        .tab-content.active { display: block; }

        /* --- MODALS --- */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-content {
            width: 550px; max-width: 90%; background: #151515; border: 1px solid #333;
            border-radius: 20px; padding: 30px; text-align: center; position: relative;
            box-shadow: 0 0 50px rgba(0,242,96,0.1);
        }

        /* --- ANIMATIONS --- */
        @keyframes histAnim { 0% { height: 20%; } 100% { height: 100%; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 96, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 242, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 96, 0); } }

    </style>
</head>
<body class="portrait-mode">

    <div id="bootScreen">
        <div style="font-size:2rem; font-weight:900; letter-spacing:4px; color:white;">NEOBOOTH <span style="color:#00f260">AI</span></div>
        <div style="font-family:monospace; margin-top:10px; opacity:0.6;">INITIALIZING CORE SYSTEMS...</div>
        <div class="loader-bar"><div class="loader-progress" id="loaderBar"></div></div>
    </div>

    <div class="app-layout">
        
        <aside class="panel sidebar-left">
            <div class="panel-header">
                <span class="panel-title">System Config</span>
                <div style="font-size:0.7rem; font-family:monospace; opacity:0.5;">v5.2.0 PRO</div>
            </div>

            <div class="control-group">
                <div class="group-label">Device Layout</div>
                <div class="btn-grid">
                    <button class="btn" onclick="toggleLayout()">üîÑ Rotate UI</button>
                    <button class="btn" onclick="toggleTheme()">üé® Theme</button>
                </div>
            </div>

            <div class="control-group">
                <div class="group-label">Capture Mode</div>
                <div class="btn-grid">
                    <button class="btn active" id="mode-single" onclick="setMode('single')">üì∏ Single</button>
                    <button class="btn" id="mode-burst" onclick="setMode('burst')">üöÄ Burst</button>
                    <button class="btn" id="mode-square" onclick="setMode('square')">‚¨ú 1:1</button>
                    <button class="btn" id="mode-pano" onclick="setMode('pano')">üèîÔ∏è Wide</button>
                </div>
                <div class="btn-grid">
                    <button class="btn" id="mode-gif" onclick="setMode('gif')">üéûÔ∏è GIF</button>
                    <button class="btn" id="mode-slow" onclick="setMode('slow')">üê¢ Slow-Mo</button>
                </div>
            </div>

            <div class="control-group">
                <div class="group-label">Camera Optics</div>
                <div class="slider-wrap">
                    <div class="slider-header"><span>Digital Zoom</span><span id="zoomVal">1.0x</span></div>
                    <input type="range" min="1" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
                </div>
                <div class="btn-grid">
                    <button class="btn" onclick="toggleMirror()">‚ÜîÔ∏è Flip</button>
                    <button class="btn" onclick="toggleGrid()">‚ñ¶ Grid</button>
                    <button class="btn" onclick="toggleFlash()">‚ö° Flash</button>
                </div>
            </div>

            <div style="margin-top:auto">
                <div class="group-label">System</div>
                <div class="btn-grid">
                    <button class="btn" onclick="toggleAccess()">üëÅÔ∏è Contrast</button>
                    <button class="btn" onclick="toggleVoice()">üîä Voice</button>
                </div>
            </div>
        </aside>

        <main class="stage-center">
            <div class="viewport-container" id="viewport">
                <video id="videoFeed" autoplay playsinline muted></video>
                
                <canvas id="mainCanvas" style="display:none;"></canvas>
                <canvas id="drawCanvas" style="display:none; z-index:20;"></canvas>
                
                <div class="hud-overlay" id="hudLayer">
                    <div class="hud-corner tl"></div><div class="hud-corner tr"></div>
                    <div class="hud-corner bl"></div><div class="hud-corner br"></div>
                    
                    <div class="hud-histogram">
                        <div class="hist-bar" style="animation-duration:0.4s; height:40%"></div>
                        <div class="hist-bar" style="animation-duration:0.7s; height:70%"></div>
                        <div class="hist-bar" style="animation-duration:0.3s; height:30%"></div>
                        <div class="hist-bar" style="animation-duration:0.5s; height:60%"></div>
                        <div class="hist-bar" style="animation-duration:0.6s; height:50%"></div>
                    </div>
                    
                    <div id="recIndicator" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:red; color:white; padding:5px 10px; border-radius:4px; font-size:0.7rem; display:none; animation:pulse 1s infinite;">REC ‚óè</div>
                </div>

                <div class="layer-interactive" id="stickerLayer"></div>

                <div id="countdown" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:10rem; font-weight:900; color:white; text-shadow:0 0 50px black; display:none; z-index:100;">3</div>
            </div>

            <button id="snapBtn" onclick="startCapture()" style="margin-top:30px; width:80px; height:80px; border-radius:50%; background:var(--primary); border:6px solid rgba(255,255,255,0.2); box-shadow: 0 0 30px var(--primary); cursor:pointer; transition:0.2s;"></button>
        </main>

        <aside class="panel sidebar-right" id="creativeLab" style="opacity:0.5; pointer-events:none;">
            <div class="panel-header">
                <span class="panel-title">Creative Lab+</span>
            </div>

            <div class="tab-group">
                <div class="tab active" onclick="setTab('filter')">Filters</div>
                <div class="tab" onclick="setTab('layout')">Layout</div>
                <div class="tab" onclick="setTab('decor')">Decor</div>
            </div>

            <div id="tab-filter" class="tab-content active">
                <div class="btn-grid" style="margin-bottom:15px;">
                    <button class="btn" onclick="applyPreset('none')">Normal</button>
                    <button class="btn" onclick="applyPreset('cyber')">Cyber</button>
                    <button class="btn" onclick="applyPreset('1977')">1977</button>
                    <button class="btn" onclick="applyPreset('night')">Night</button>
                </div>
                
                <div class="slider-wrap" style="margin-bottom:10px;">
                    <div class="slider-header"><span>Brightness</span></div>
                    <input type="range" min="50" max="150" value="100" oninput="updateFilter('brightness', this.value)">
                </div>
                <div class="slider-wrap" style="margin-bottom:10px;">
                    <div class="slider-header"><span>Contrast</span></div>
                    <input type="range" min="50" max="150" value="100" oninput="updateFilter('contrast', this.value)">
                </div>
                <div class="slider-wrap" style="margin-bottom:10px;">
                    <div class="slider-header"><span>Saturation</span></div>
                    <input type="range" min="0" max="200" value="100" oninput="updateFilter('saturate', this.value)">
                </div>
                <div class="slider-wrap">
                    <div class="slider-header"><span>Hue Shift</span></div>
                    <input type="range" min="0" max="360" value="0" oninput="updateFilter('hue-rotate', this.value+'deg')">
                </div>
            </div>

            <div id="tab-layout" class="tab-content">
                <div class="btn-grid" style="margin-bottom:15px;">
                    <button class="btn" onclick="setLayout('single')">Full</button>
                    <button class="btn" onclick="setLayout('strip')">Strip</button>
                    <button class="btn" onclick="setLayout('grid')">Grid</button>
                    <button class="btn" onclick="setLayout('masonry')">Masonry</button>
                </div>
                <div class="slider-wrap">
                    <div class="slider-header"><span>Frame Padding</span></div>
                    <input type="range" min="0" max="100" value="20" oninput="state.layout.padding=parseInt(this.value); render();">
                </div>
            </div>

            <div id="tab-decor" class="tab-content">
                <div class="group-label">Stickers</div>
                <div class="btn-grid" style="font-size:1.5rem;">
                    <button class="btn" onclick="addSticker('üòé')">üòé</button>
                    <button class="btn" onclick="addSticker('üëë')">üëë</button>
                    <button class="btn" onclick="addSticker('üåà')">üåà</button>
                    <button class="btn" onclick="addSticker('üî•')">üî•</button>
                </div>
                
                <div class="group-label" style="margin-top:20px;">Doodle</div>
                <div class="btn-grid">
                    <button class="btn" onclick="toggleDraw(true)">üñäÔ∏è Draw</button>
                    <button class="btn danger" onclick="clearDraw()">‚ùå Clear</button>
                </div>
                <div class="slider-wrap" style="margin-top:10px;">
                    <div class="slider-header"><span>Brush Size</span></div>
                    <input type="range" min="2" max="50" value="5" oninput="state.draw.size=this.value">
                </div>
            </div>

            <button class="btn active" style="margin-top:auto; height:50px; font-size:1rem;" onclick="openPrivacyModal()">üöÄ PROCEED TO SHARE</button>
        </aside>
    </div>

    <div class="modal-backdrop" id="privacyModal">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin-bottom:10px;">SECURE DOWNLOAD</h2>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; font-size:0.8rem; text-align:left; color:var(--text-muted); margin-bottom:20px;">
                <strong>PRIVACY PROTOCOL ACTIVATED:</strong><br>
                This session is end-to-end local. Your photos reside in your device's RAM and are wiped upon closure. No external cloud upload occurs without explicit action.
            </div>
            
            <div style="background:white; padding:10px; border-radius:10px; display:inline-block; margin-bottom:10px;">
                <div id="qrcode"></div>
            </div>
            <div style="font-size:0.7rem; color:#666;">Scan for Policy & Mobile Save</div>

            <div class="btn-grid" style="margin-top:20px;">
                <button class="btn active" onclick="downloadImage()">‚¨áÔ∏è Save to Device</button>
                <button class="btn" onclick="alert('Social API Handshake...')">‚òÅÔ∏è Social</button>
            </div>
            <button class="btn danger" style="width:100%; margin-top:10px;" onclick="resetApp()">Close & Clear Data</button>
        </div>
    </div>

    <script>
        // --- CORE ENGINE ---
        const state = {
            mode: 'single', 
            photos: [],
            layout: { type: 'single', padding: 20 },
            filter: { brightness: 100, contrast: 100, saturate: 100, hue: '0deg', preset: 'none' },
            draw: { active: false, size: 5, color: '#00f260' },
            cam: { zoom: 1, mirror: false }
        };

        const els = {
            video: document.getElementById('videoFeed'),
            canvas: document.getElementById('mainCanvas'),
            drawLayer: document.getElementById('drawCanvas'),
            stickerLayer: document.getElementById('stickerLayer'),
            viewport: document.getElementById('viewport'),
            countdown: document.getElementById('countdown'),
            creativeLab: document.getElementById('creativeLab'),
            snapBtn: document.getElementById('snapBtn')
        };

        const ctx = els.canvas.getContext('2d');
        const dCtx = els.drawLayer.getContext('2d');

        // --- BOOT SEQUENCE ---
        window.onload = async () => {
            const loader = document.getElementById('loaderBar');
            loader.style.width = '100%';
            setTimeout(async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1920, height: 1080 } });
                    els.video.srcObject = stream;
                    document.getElementById('bootScreen').style.opacity = 0;
                    setTimeout(() => document.getElementById('bootScreen').remove(), 800);
                } catch(e) {
                    alert("Camera Permission Required");
                }
            }, 1000);
            
            setupDrawing();
        };

        // --- UI ADAPTATION ---
        function toggleLayout() {
            document.body.classList.toggle('portrait-mode');
        }

        function toggleTheme() {
            const themes = ['cyber', 'neon', 'gold', 'minimal'];
            const current = document.documentElement.getAttribute('data-theme') || 'cyber';
            const next = themes[(themes.indexOf(current) + 1) % themes.length];
            document.documentElement.setAttribute('data-theme', next);
        }

        // --- CAMERA LOGIC ---
        function updateZoom(val) {
            state.cam.zoom = val;
            applyCamTransform();
        }
        function toggleMirror() {
            state.cam.mirror = !state.cam.mirror;
            applyCamTransform();
        }
        function applyCamTransform() {
            const scaleX = state.cam.mirror ? -state.cam.zoom : state.cam.zoom;
            els.video.style.transform = `scale(${scaleX}, ${state.cam.zoom})`;
        }
        function toggleGrid() {
            // Toggle grid overlay logic (simplified)
            els.viewport.style.backgroundImage = els.viewport.style.backgroundImage ? '' : 'linear-gradient(to right, rgba(255,255,255,0.2) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.2) 1px, transparent 1px)';
            els.viewport.style.backgroundSize = '33.3% 33.3%';
        }
        function toggleFlash() {
            const f = document.createElement('div');
            f.style.cssText = "position:absolute; inset:0; background:white; z-index:999; animation: fadeOut 0.5s forwards;";
            els.viewport.appendChild(f);
            setTimeout(() => f.remove(), 500);
        }

        // --- CAPTURE MODES ---
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('.btn-grid button').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-'+m).classList.add('active');
            
            els.viewport.className = 'viewport-container'; // Reset
            if(m === 'square') els.viewport.classList.add('square');
            if(m === 'pano') els.viewport.classList.add('portrait'); // Reusing portrait class for "Tall/Wide" feel or adapt css
        }

        function startCapture() {
            state.photos = [];
            let count = (state.mode === 'burst') ? 4 : 1;
            let taken = 0;

            const snap = () => {
                if(taken >= count) { finishSession(); return; }
                
                let timer = 3;
                els.countdown.style.display = 'block';
                const int = setInterval(() => {
                    els.countdown.innerText = timer;
                    if(timer === 0) {
                        clearInterval(int);
                        els.countdown.style.display = 'none';
                        toggleFlash();
                        
                        // Capture logic
                        const c = document.createElement('canvas');
                        c.width = els.video.videoWidth; c.height = els.video.videoHeight;
                        const t = c.getContext('2d');
                        t.translate(c.width, 0); t.scale(-1, 1); // Mirror capture
                        t.drawImage(els.video, 0, 0);
                        
                        const img = new Image();
                        img.src = c.toDataURL();
                        img.onload = () => {
                            state.photos.push(img);
                            taken++;
                            if(count > 1) setTimeout(snap, 500); else finishSession();
                        }
                    }
                    timer--;
                }, 800);
            };
            snap();
        }

        function finishSession() {
            els.video.style.display = 'none';
            els.canvas.style.display = 'block';
            els.drawLayer.style.display = 'block';
            els.snapBtn.style.display = 'none';
            els.creativeLab.style.opacity = 1; 
            els.creativeLab.style.pointerEvents = 'auto';
            
            // Auto layout
            if(state.mode === 'burst') setLayout('grid');
            else setLayout('single');
        }

        // --- CREATIVE LAB ---
        function setTab(t) {
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
        }

        function applyPreset(p) {
            state.filter.preset = p;
            if(p === 'cyber') { state.filter.contrast=120; state.filter.saturate=150; state.filter.hue='10deg'; }
            if(p === '1977') { state.filter.contrast=90; state.filter.saturate=80; state.filter.hue='0deg'; /* Add Sepia logic in render */ }
            render();
        }

        function updateFilter(k, v) { state.filter[k] = v; render(); }
        function setLayout(t) { state.layout.type = t; render(); }

        function render() {
            if(state.photos.length === 0) return;
            const w = 1920; const h = 1080;
            els.canvas.width = w; els.canvas.height = h;
            els.drawLayer.width = w; els.drawLayer.height = h; // Sync draw layer
            
            // Background
            ctx.fillStyle = "#111";
            ctx.fillRect(0,0,w,h);

            // Filters
            ctx.filter = `brightness(${state.filter.brightness}%) contrast(${state.filter.contrast}%) saturate(${state.filter.saturate}%) hue-rotate(${state.filter.hue})`;

            // Layout
            const p = state.layout.padding * 2;
            const imgs = state.photos;
            
            const drawImg = (img, x, y, dw, dh) => {
                // Aspect Ratio Cover Logic
                const r = Math.max(dw/img.width, dh/img.height);
                const cx = (dw - img.width*r)/2;
                const cy = (dh - img.height*r)/2;
                ctx.drawImage(img, 0, 0, img.width, img.height, x+cx, y+cy, img.width*r, img.height*r);
            };

            if(state.layout.type === 'single') drawImg(imgs[0], p, p, w-p*2, h-p*2);
            else if(state.layout.type === 'grid') {
                const cw = (w-p*3)/2; const ch = (h-p*3)/2;
                for(let i=0; i<4; i++) {
                    const col = i%2; const row = Math.floor(i/2);
                    drawImg(imgs[i]||imgs[0], p+col*(cw+p), p+row*(ch+p), cw, ch);
                }
            }
            
            ctx.filter = 'none';
        }

        // --- DRAWING & STICKERS ---
        function setupDrawing() {
            let painting = false;
            const start = (e) => { 
                if(!state.draw.active) return;
                painting = true; draw(e); 
            };
            const end = () => { painting = false; dCtx.beginPath(); };
            const draw = (e) => {
                if(!painting) return;
                const rect = els.drawLayer.getBoundingClientRect();
                const x = ( (e.touches ? e.touches[0].clientX : e.clientX) - rect.left ) * (els.drawLayer.width / rect.width);
                const y = ( (e.touches ? e.touches[0].clientY : e.clientY) - rect.top ) * (els.drawLayer.height / rect.height);
                
                dCtx.lineWidth = state.draw.size;
                dCtx.lineCap = 'round';
                dCtx.strokeStyle = state.draw.color;
                dCtx.lineTo(x, y); dCtx.stroke(); dCtx.beginPath(); dCtx.moveTo(x, y);
            };
            
            // Mouse
            els.drawLayer.addEventListener('mousedown', start);
            window.addEventListener('mouseup', end);
            els.drawLayer.addEventListener('mousemove', draw);
            // Touch
            els.drawLayer.addEventListener('touchstart', (e)=>{ e.preventDefault(); start(e); });
            window.addEventListener('touchend', end);
            els.drawLayer.addEventListener('touchmove', (e)=>{ e.preventDefault(); draw(e); }, {passive:false});
        }

        function toggleDraw(active) {
            state.draw.active = active;
            els.drawLayer.style.pointerEvents = active ? 'auto' : 'none';
            els.stickerLayer.style.pointerEvents = active ? 'none' : 'auto'; // Prevent dragging stickers while drawing
        }
        function clearDraw() { dCtx.clearRect(0,0,els.drawLayer.width, els.drawLayer.height); }

        function addSticker(emoji) {
            const el = document.createElement('div');
            el.className = 'sticker-el';
            el.innerText = emoji;
            el.style.left = '40%'; el.style.top = '40%';
            makeDraggable(el);
            els.stickerLayer.appendChild(el);
        }

        function makeDraggable(el) {
            let isDown = false, offX, offY;
            const start = (e) => { 
                isDown = true; 
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                offX = el.offsetLeft - cx; offY = el.offsetTop - cy;
            };
            const end = () => isDown = false;
            const move = (e) => {
                if(!isDown) return;
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                el.style.left = (cx + offX) + 'px';
                el.style.top = (cy + offY) + 'px';
            };
            
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move, {passive:false});
        }

        // --- EXPORT ---
        function openPrivacyModal() {
            document.getElementById('privacyModal').style.display = 'flex';
            const qr = document.getElementById('qrcode');
            qr.innerHTML = '';
            new QRCode(qr, { text: "PRIVACY POLICY: Local Storage Only. Save your photos.", width: 100, height: 100 });
        }

        function downloadImage() {
            // Composite Logic
            const finalC = document.createElement('canvas');
            finalC.width = 1920; finalC.height = 1080;
            const f = finalC.getContext('2d');
            f.drawImage(els.canvas, 0, 0);
            f.drawImage(els.drawLayer, 0, 0); // Overlay drawings
            
            const link = document.createElement('a');
            link.download = 'neobooth_pro.jpg';
            link.href = finalC.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        function resetApp() {
            document.getElementById('privacyModal').style.display = 'none';
            els.video.style.display = 'block';
            els.canvas.style.display = 'none';
            els.drawLayer.style.display = 'none';
            els.creativeLab.style.opacity = 0.5;
            els.creativeLab.style.pointerEvents = 'none';
            els.snapBtn.style.display = 'block';
            els.stickerLayer.innerHTML = '';
            clearDraw();
        }
        
        function toggleAccess() { document.body.classList.toggle('access-mode'); }
    </script>
</body>
</html>
