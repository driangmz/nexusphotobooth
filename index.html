<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PRO Photo Booth | Studio Edition V3.5</title>
    
    <style>
        /* * ==========================================================================
         * 1. RESET & CORE VARIABLES
         * ==========================================================================
         */
        :root {
            /* --- COLOR PALETTE --- */
            --color-primary: #00f2ea;
            --color-primary-dim: rgba(0, 242, 234, 0.15);
            --color-secondary: #ff0050;
            --color-accent: #ffee00;
            --color-bg: #000000;
            --color-surface: #111111;
            --color-surface-trans: rgba(17, 17, 17, 0.9);
            --color-border: rgba(255, 255, 255, 0.12);
            --color-text-main: #ffffff;
            --color-text-muted: #888888;

            /* --- DIMENSIONS & SPACING --- */
            --header-height: 50px;
            --control-deck-height: 240px; /* Tall enough for thumbs */
            --control-deck-width: 140px;  /* For landscape sidebar */
            
            /* --- SAFE AREAS (CRITICAL FOR MOBILE) --- */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);

            /* --- ANIMATION --- */
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            color: var(--color-text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Lock scroll */
            position: fixed; /* Prevent iOS rubber-banding */
        }

        /* --- TRUE FLASH OVERRIDE --- */
        body.flash-active {
            background-color: #ffffff !important;
        }
        body.flash-active * {
            visibility: hidden !important;
        }

        /* * ==========================================================================
         * 2. ANIMATIONS
         * ==========================================================================
         */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulseRec { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes flashBang { 0% { background: white; opacity: 1; } 100% { background: transparent; opacity: 0; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* * ==========================================================================
         * 3. LAYOUT ARCHITECTURE (FLEX ENGINE)
         * ==========================================================================
         */
        
        #app-root {
            display: flex;
            width: 100%;
            height: 100%;
            /* Fix for mobile browser bars */
            height: 100dvh; 
            flex-direction: column; /* Default: Portrait */
            position: relative;
            z-index: 1;
        }

        /* --- HEADER --- */
        #top-bar {
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            padding-top: var(--safe-top);
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 20;
            flex-shrink: 0; /* Never shrink */
            border-bottom: 1px solid var(--color-border);
        }

        .logo-text { font-weight: 900; font-size: 1rem; letter-spacing: 2px; }
        .header-actions { display: flex; gap: 15px; }

        /* --- WORKSPACE (The Camera) --- */
        #workspace {
            flex-grow: 1; /* Take all available space */
            position: relative;
            background: #000;
            display: flex;
            align-items: center; /* Center Vertically */
            justify-content: center; /* Center Horizontally */
            overflow: hidden;
            padding: 10px;
        }

        .viewfinder {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            background: #050505;
            box-shadow: 0 0 0 1px #222;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--ease-smooth);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: block;
        }
        .no-mirror video { transform: scaleX(1); }

        /* --- CONTROL DECK --- */
        #control-deck {
            flex-shrink: 0; /* Never shrink */
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            z-index: 30;
            display: flex;
            flex-direction: column;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            gap: 20px;
        }

        /* * ==========================================================================
         * 4. UI COMPONENTS (CONTROLS)
         * ==========================================================================
         */

        /* Filter Strip */
        .filter-scroller {
            width: 100%;
            overflow-x: auto;
            display: flex;
            gap: 10px;
            padding-bottom: 5px;
            scrollbar-width: none; /* Hide scrollbars */
        }
        .filter-scroller::-webkit-scrollbar { display: none; }

        .filter-chip {
            background: #222;
            border: 1px solid #333;
            color: #888;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip.active {
            background: var(--color-text-main);
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        /* Main Actions Row */
        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* Side Buttons Group */
        .side-actions {
            display: flex;
            gap: 15px;
            flex: 1; /* Take up side space */
        }
        .side-actions.left { justify-content: flex-start; }
        .side-actions.right { justify-content: flex-end; }

        .btn-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-circle:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .btn-circle.active { color: var(--color-accent); border-color: var(--color-accent); box-shadow: 0 0 10px rgba(255,238,0,0.2); }

        /* Shutter Button */
        .shutter-container {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .shutter-outer {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 4px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .shutter-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--color-secondary);
            transition: transform 0.1s;
        }
        .shutter-outer:active { transform: scale(0.95); }
        .shutter-outer:active .shutter-inner { transform: scale(0.9); }

        /* * ==========================================================================
         * 5. ORIENTATION & RESPONSIVE LOGIC (THE FIX)
         * ==========================================================================
         */

        /* A. MOBILE PORTRAIT (Default) */
        @media (orientation: portrait) {
            #app-root { flex-direction: column; }
            #top-bar { display: flex; }
            
            #workspace { padding: 10px 0; } /* Remove side padding to max width */
            
            .viewfinder {
                width: 100%;
                /* Let flexbox handle height, but ensure aspect ratio feels good */
                height: 100%; 
                border-radius: 20px;
                max-width: 100%;
            }
            
            #control-deck {
                width: 100%;
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            }
        }

        /* B. MOBILE LANDSCAPE (Side-by-Side) */
        @media (orientation: landscape) and (max-height: 500px) {
            #app-root { flex-direction: row; }
            #top-bar { display: none; } /* Hide top bar to save space */

            #workspace { padding: 0; width: auto; height: 100%; }
            .viewfinder { border-radius: 0; width: 100%; height: 100%; border: none; }

            #control-deck {
                width: var(--control-deck-width);
                height: 100%;
                border-top: none;
                border-left: 1px solid var(--color-border);
                padding: 10px;
                padding-right: calc(10px + var(--safe-right));
                justify-content: center;
                gap: 15px;
            }

            /* Rotate Layouts for Sidebar */
            .filter-scroller {
                flex-direction: column;
                height: 120px;
                width: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                order: 1; /* Move to top */
            }
            .filter-chip { text-align: center; width: 100%; }

            .actions-row {
                flex-direction: column-reverse;
                height: auto;
                gap: 15px;
                order: 2;
            }

            .side-actions { flex-direction: column; width: 100%; align-items: center; justify-content: center; }
            .side-actions.left { margin-top: 10px; }
            .side-actions.right { margin-bottom: 10px; }
        }

        /* C. DESKTOP / TABLET */
        @media (min-width: 769px) and (min-height: 501px) {
            #workspace { padding: 40px; }
            .viewfinder {
                max-width: 1200px;
                box-shadow: 0 30px 80px rgba(0,0,0,0.6);
                border: 2px solid #333;
            }
            
            #control-deck {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                padding: 20px;
                background: #000;
            }
            .filter-scroller { width: 300px; margin-right: 40px; justify-content: center; }
            .actions-row { max-width: 600px; }
        }

        /* * ==========================================================================
         * 6. OVERLAYS & MODALS
         * ==========================================================================
         */
        
        .overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* REC Tag */
        .rec-tag {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px;
            display: flex; align-items: center; gap: 6px;
            font-family: monospace; font-size: 0.75rem; color: #fff;
        }
        .rec-dot { width: 8px; height: 8px; background: red; border-radius: 50%; animation: pulseRec 2s infinite; }

        /* Grid */
        .grid-guide { width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s; }
        .grid-guide.visible { opacity: 1; }
        .g-h { position: absolute; left: 0; width: 100%; height: 1px; background: rgba(255,255,255,0.3); }
        .g-v { position: absolute; top: 0; height: 100%; width: 1px; background: rgba(255,255,255,0.3); }

        /* Countdown */
        .countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 8rem; font-weight: 900; color: #fff;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s;
        }

        /* Flash */
        .flash-white {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; z-index: 100; pointer-events: none;
        }

        /* MODALS */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-backdrop.active { display: flex; opacity: 1; }
        .modal-card {
            background: #151515; border: 1px solid #333; width: 90%; max-width: 400px;
            border-radius: 20px; overflow: hidden; animation: slideUp 0.3s var(--ease-elastic);
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; color: #aaa; font-size: 0.9rem; line-height: 1.6; }
        
        /* SETTINGS ROWS */
        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .opt-label { font-weight: 500; color: #fff; }

        /* BOOT SCREEN */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
        .boot-title { font-size: 3rem; font-weight: 900; margin: 0; letter-spacing: -2px; color: #fff; }
        .boot-sub { color: #666; margin: 10px 0 30px 0; }
        .btn-boot {
            background: #fff; color: #000; padding: 15px 40px; border-radius: 50px;
            border: none; font-weight: 700; font-size: 1rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,255,255,0.2); animation: pop 2s infinite;
        }

        /* Utils */
        .hidden { display: none !important; }
        canvas { display: none; }

    </style>
</head>
<body>

    <div id="boot-screen">
        <h1 class="boot-title">STUDIO<br><span style="color:var(--primary)">ULTIMATE</span></h1>
        <p class="boot-sub">Mobile-First Photography Suite V3.5<br>Orientation Adaptive â€¢ True Flash</p>
        <button class="btn-boot" onclick="app.init()">START CAMERA</button>
        <div style="margin-top:30px; font-size:0.8rem;">
            <a style="color:#555; margin:0 10px;" onclick="ui.modal('privacy')">Privacy</a>
            <a style="color:#555; margin:0 10px;" onclick="ui.modal('settings')">Settings</a>
        </div>
    </div>

    <div id="app-root" class="hidden">
        
        <div id="top-bar">
            <div class="logo-text">STUDIO<span style="color:var(--primary)">.PRO</span></div>
            <div class="header-actions">
                <button class="btn-icon" style="width:36px; height:36px;" onclick="ui.modal('settings')">âš™</button>
                <button class="btn-icon" style="width:36px; height:36px;" onclick="gallery.open()">ðŸ–¼</button>
            </div>
        </div>

        <div id="workspace">
            <div class="viewfinder" id="viewfinder-box">
                <video id="video-feed" autoplay playsinline muted></video>
                
                <div class="overlay-layer">
                    <div class="rec-tag"><div class="rec-dot"></div> <span id="res-label">HD</span></div>
                    
                    <div id="grid-system" class="grid-guide">
                        <div class="g-h" style="top:33%"></div><div class="g-h" style="top:66%"></div>
                        <div class="g-v" style="left:33%"></div><div class="g-v" style="left:66%"></div>
                    </div>

                    <div id="countdown" class="countdown">3</div>
                    <div id="flash-layer" class="flash-white"></div>
                </div>
            </div>
        </div>

        <div id="control-deck">
            
            <div class="filter-scroller" id="filter-container">
                </div>

            <div class="actions-row">
                
                <div class="side-actions left">
                    <button class="btn-circle" id="btn-grid" onclick="app.toggleGrid(this)">#</button>
                    <button class="btn-circle" id="btn-flash" onclick="app.toggleFlash(this)">âš¡</button>
                </div>

                <div class="shutter-container">
                    <div class="shutter-outer" onclick="app.snap()">
                        <div class="shutter-inner"></div>
                    </div>
                </div>

                <div class="side-actions right">
                    <button class="btn-circle" onclick="app.switchCam()">â†»</button>
                    <button class="btn-circle" onclick="app.cycleRatio()">1:1</button>
                </div>

            </div>
        </div>

    </div>

    <div id="modal-settings" class="modal-backdrop">
        <div class="modal-card">
            <div class="modal-header"><h3>Settings</h3><button class="btn-icon" style="width:30px;height:30px;" onclick="ui.closeAll()">âœ•</button></div>
            <div class="modal-body">
                <div class="opt-row">
                    <span class="opt-label">Mirror Selfie</span>
                    <label class="toggle-switch"><input type="checkbox" id="cfg-mirror" checked onchange="app.updateCfg()"><span class="slider"></span></label>
                </div>
                <div class="opt-row">
                    <span class="opt-label">Shutter Sound</span>
                    <label class="toggle-switch"><input type="checkbox" id="cfg-sound" checked><span class="slider"></span></label>
                </div>
                <div class="opt-row">
                    <span class="opt-label">Burst Mode (3x)</span>
                    <label class="toggle-switch"><input type="checkbox" id="cfg-burst"><span class="slider"></span></label>
                </div>
                <div class="opt-row">
                    <span class="opt-label">Haptic Feedback</span>
                    <label class="toggle-switch"><input type="checkbox" id="cfg-haptic" checked><span class="slider"></span></label>
                </div>
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #333;">
                    <button class="btn-pill" style="width:100%; text-align:center;" onclick="gallery.clear()">Clear Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-privacy" class="modal-backdrop">
        <div class="modal-card">
            <div class="modal-header"><h3>Privacy</h3><button class="btn-icon" style="width:30px;height:30px;" onclick="ui.closeAll()">âœ•</button></div>
            <div class="modal-body">
                <p><strong>1. Local Only:</strong> This app runs entirely in your browser. No images are sent to the cloud.</p>
                <p><strong>2. Temporary:</strong> Images are stored in RAM. Refreshing the page deletes them.</p>
                <p><strong>3. Camera:</strong> Access is used strictly for the viewfinder and capture.</p>
            </div>
        </div>
    </div>

    <canvas id="hidden-canvas" class="hidden"></canvas>

    <script>
        // --- CONSTANTS & STATE ---
        const FILTERS = [
            { id: 'none', name: 'Original', css: 'none' },
            { id: 'bw', name: 'Mono', css: 'grayscale(100%) contrast(1.2)' },
            { id: 'vivid', name: 'Vivid', css: 'saturate(1.5) contrast(1.1)' },
            { id: 'warm', name: 'Warm', css: 'sepia(0.4) saturate(1.2)' },
            { id: 'cool', name: 'Cool', css: 'hue-rotate(180deg) opacity(0.9)' },
            { id: 'drama', name: 'Drama', css: 'contrast(1.4) saturate(0.8)' },
            { id: 'cyber', name: 'Cyber', css: 'hue-rotate(-20deg) saturate(2)' },
            { id: 'silv', name: 'Silver', css: 'grayscale(100%) brightness(1.2)' }
        ];

        const RATIOS = [
            { cls: 'ratio-16-9', w: 16, h: 9 },
            { cls: 'ratio-4-3', w: 4, h: 3 },
            { cls: 'ratio-1-1', w: 1, h: 1 }
        ];

        const state = {
            stream: null,
            isCapturing: false,
            filter: 'none',
            facingMode: 'user',
            flash: false,
            ratioIndex: 0,
            cfg: { mirror: true, sound: true, burst: false, haptic: true }
        };

        // --- UI CONTROLLER ---
        const ui = {
            el: (id) => document.getElementById(id),
            
            modal: (id) => document.getElementById(`modal-${id}`).classList.add('active'),
            closeAll: () => document.querySelectorAll('.modal-backdrop').forEach(el => el.classList.remove('active')),

            renderFilters: () => {
                const con = ui.el('filter-container');
                FILTERS.forEach((f, i) => {
                    const b = document.createElement('button');
                    b.className = `filter-chip ${i===0 ? 'active' : ''}`;
                    b.innerText = f.name;
                    b.onclick = () => {
                        document.querySelectorAll('.filter-chip').forEach(x => x.classList.remove('active'));
                        b.classList.add('active');
                        state.filter = f.css;
                        ui.el('video-feed').style.filter = f.css;
                    };
                    con.appendChild(b);
                });
            }
        };

        // --- APP ENGINE ---
        const app = {
            
            init: async () => {
                // Initialize Camera
                try {
                    const constraints = {
                        video: {
                            facingMode: state.facingMode,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    };
                    state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    ui.el('video-feed').srcObject = state.stream;
                    
                    // Transition to App
                    ui.el('boot-screen').style.opacity = 0;
                    ui.el('app-root').classList.remove('hidden');
                    setTimeout(() => ui.el('boot-screen').style.display = 'none', 500);
                    
                    app.updateConfig();
                    ui.renderFilters();

                } catch (err) {
                    alert("Camera access denied. Please check permissions.");
                }
            },

            updateConfig: () => {
                state.cfg.mirror = ui.el('cfg-mirror').checked;
                state.cfg.sound = ui.el('cfg-sound').checked;
                state.cfg.burst = ui.el('cfg-burst').checked;
                state.cfg.haptic = ui.el('cfg-haptic').checked;

                const v = ui.el('video-feed');
                if (state.cfg.mirror && state.facingMode === 'user') v.classList.remove('no-mirror');
                else v.classList.add('no-mirror');
            },

            // Toggles
            toggleFlash: (btn) => {
                state.flash = !state.flash;
                btn.classList.toggle('active');
            },
            toggleGrid: (btn) => {
                ui.el('grid-system').classList.toggle('visible');
                btn.classList.toggle('active');
            },
            switchCam: () => {
                state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
                if(state.stream) state.stream.getTracks().forEach(t=>t.stop());
                app.init();
            },
            cycleRatio: () => {
                state.ratioIndex = (state.ratioIndex + 1) % RATIOS.length;
                const r = RATIOS[state.ratioIndex];
                const v = ui.el('viewfinder-box');
                // Note: Aspect ratio CSS works best on desktop. On mobile portrait we usually fill.
                // We will apply the class anyway for desktop correctness.
                v.className = `viewfinder ratio-${r.w}-${r.h}`;
            },

            // Capture Logic
            snap: async () => {
                if(state.isCapturing) return;
                state.isCapturing = true;

                // Animation
                const btn = document.querySelector('.shutter-outer');
                btn.style.transform = 'scale(0.9)';
                setTimeout(() => btn.style.transform = 'scale(1)', 100);

                // Countdown
                const cd = ui.el('countdown');
                cd.style.opacity = 1;
                for(let i=3; i>0; i--) {
                    cd.innerText = i;
                    if(state.cfg.haptic && navigator.vibrate) navigator.vibrate(50);
                    await new Promise(r => setTimeout(r, 1000));
                }
                cd.style.opacity = 0;

                // Capture Sequence
                const count = state.cfg.burst ? 3 : 1;
                for(let i=0; i<count; i++) {
                    await app.takePhoto();
                    if(i < count - 1) await new Promise(r => setTimeout(r, 800));
                }

                state.isCapturing = false;
            },

            takePhoto: async () => {
                // True Flash Logic
                if(state.flash) {
                    document.body.classList.add('flash-active');
                    // Brightness ramp up
                    await new Promise(r => setTimeout(r, 150));
                }

                // Haptic & Sound
                if(state.cfg.haptic && navigator.vibrate) navigator.vibrate(100);
                if(state.cfg.sound) {
                    // Simple beep via Web Audio API (No external file needed)
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800;
                    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                }

                // Draw to Canvas
                const vid = ui.el('video-feed');
                const canvas = ui.el('hidden-canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = vid.videoWidth;
                canvas.height = vid.videoHeight;

                ctx.save();
                if(state.cfg.mirror && state.facingMode === 'user') {
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                }
                if(state.filter !== 'none') ctx.filter = state.filter;
                ctx.drawImage(vid, 0, 0);
                ctx.restore();

                // Flash Off
                if(state.flash) {
                    document.body.classList.remove('flash-active');
                    const fx = ui.el('flash-layer');
                    fx.style.animation = 'none';
                    fx.offsetHeight; 
                    fx.style.animation = 'flashBang 0.5s ease-out';
                }

                // Save
                gallery.save(canvas.toDataURL('image/jpeg', 0.95));
            }
        };

        const gallery = {
            save: (url) => {
                const a = document.createElement('a');
                a.href = url;
                a.download = `studio_${Date.now()}.jpg`;
                a.click();
            },
            open: () => {
                const i = document.createElement('input');
                i.type = 'file';
                i.accept = 'image/*';
                i.click();
            },
            clear: () => {
                if(confirm('Reset all settings?')) location.reload();
            }
        };

        // Listen for orientation changes to force layout recalculation if needed
        window.addEventListener('resize', () => {
            // CSS media queries handle mostly everything now, but we can hook here if needed
        });

    </script>
</body>
</html>
