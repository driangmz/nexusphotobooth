<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioOS Pro - Reference Quality</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com/3.4.17"></script>

    <style>
        /* * STUDIO OS DESIGN SYSTEM 
         * Inspired by macOS/iOS Human Interface Guidelines 
         */
        
        :root {
            --bg-app: #09090b;
            --bg-panel: #18181b;
            --bg-panel-translucent: rgba(24, 24, 27, 0.75);
            
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(255, 255, 255, 0.2);
            
            --accent-primary: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            
            --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- GLOBAL RESETS --- */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent native scroll */
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- LAYOUT GRID --- */
        .studio-shell {
            display: grid;
            grid-template-columns: 1fr 380px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            width: 100vw;
        }

        /* Mobile Layout Override */
        @media (max-width: 1024px) {
            .studio-shell {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto; /* Header, Stage, Controls */
            }
        }

        /* --- HEADER --- */
        .studio-header {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 50;
        }

        .brand-mark {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
            font-size: 1.25rem;
            background: linear-gradient(to right, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- STAGE (CAMERA VIEWPORT) --- */
        .studio-stage {
            position: relative;
            background: #000; /* Deep black for focus */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            grid-row: 2 / -1;
            grid-column: 1;
        }

        @media (max-width: 1024px) {
            .studio-stage { grid-row: 2; grid-column: 1; }
        }

        /* The Canvas is the source of truth */
        canvas#main-canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            /* Important: Object fit is handled via math in JS, not CSS */
        }

        /* --- OVERLAY HUD --- */
        .hud-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none; /* Let clicks pass to interactive layer */
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-group {
            display: flex;
            gap: 12px;
            pointer-events: auto; /* Re-enable clicks on buttons */
        }

        /* --- CONTROLS SIDEBAR --- */
        .studio-controls {
            background: var(--bg-panel);
            border-left: 1px solid var(--border-subtle);
            grid-column: 2;
            grid-row: 2 / -1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 40;
        }

        @media (max-width: 1024px) {
            .studio-controls {
                grid-column: 1;
                grid-row: 3;
                height: 45vh;
                border-left: none;
                border-top: 1px solid var(--border-subtle);
            }
        }

        /* Tabs System */
        .tab-nav {
            display: flex;
            padding: 16px;
            gap: 4px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tab-btn {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active { background: #27272a; color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .control-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Custom Scrollbar */
        .control-scroll::-webkit-scrollbar { width: 4px; }
        .control-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }

        /* UI Elements */
        .control-section { margin-bottom: 32px; animation: fadeIn 0.4s var(--ease-out-expo); }
        .section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            appearance: none;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px; height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Shutter Button */
        .shutter-container {
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid var(--border-subtle);
            background: rgba(24, 24, 27, 0.5);
            backdrop-filter: blur(10px);
        }

        .shutter-btn {
            width: 72px; height: 72px;
            border-radius: 50%;
            border: 4px solid #fff;
            background: transparent;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.1s var(--ease-out-expo);
        }
        .shutter-inner {
            width: 60px; height: 60px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.2s var(--ease-out-expo);
        }
        .shutter-btn:active { transform: scale(0.95); }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); opacity: 0.8; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .flash-overlay {
            position: fixed; inset: 0; background: white; z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.1s ease-out;
        }

        /* --- HISTOGRAM --- */
        canvas#histogram {
            width: 100px; height: 60px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- GALLERY MODAL --- */
        .modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            flex-direction: column;
        }
        .modal-backdrop.open { display: flex; }
        
        .gallery-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 40px;
            overflow-y: auto;
        }
        
        .gallery-card {
            background: #18181b;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            transition: transform 0.2s;
        }
        .gallery-card:hover { transform: translateY(-4px); border-color: var(--border-focus); }
    </style>
</head>
<body>

    <div id="flash" class="flash-overlay"></div>

    <div class="studio-shell">
        
        <header class="studio-header">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <span class="ml-4 brand-mark">StudioOS Pro</span>
            </div>
            
            <div class="flex items-center gap-4 text-xs font-mono text-gray-400">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span id="system-status">SYSTEM READY</span>
                </div>
                <span>|</span>
                <span id="resolution-stat">WAITING...</span>
            </div>
        </header>

        <div class="studio-stage">
            <div class="viewport_container">
                <canvas id="main-canvas"></canvas>
                
                <video id="source-video" autoplay playsinline style="display:none;"></video>

                <div id="interaction-layer" class="absolute inset-0 z-10 overflow-hidden">
                    </div>

                <div class="hud-overlay z-20">
                    <div class="hud-top hud-group justify-between items-start">
                        <canvas id="histogram"></canvas>
                        
                        <div class="flex flex-col gap-2">
                            <button onclick="Engine.toggleMirror()" class="bg-black/50 hover:bg-white/10 text-white p-2 rounded-lg backdrop-blur-md transition border border-white/10" title="Mirror">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            </button>
                            <button onclick="Engine.toggleCountdown()" class="bg-black/50 hover:bg-white/10 text-white p-2 rounded-lg backdrop-blur-md transition border border-white/10 font-bold text-xs w-10 h-10 flex items-center justify-center" id="timer-btn">
                                0s
                            </button>
                        </div>
                    </div>
                    
                    <div class="hud-bottom flex justify-between items-end">
                        <div class="bg-black/50 backdrop-blur-md px-3 py-1 rounded text-xs font-mono text-gray-300 border border-white/10">
                            ISO <span class="text-white">AUTO</span>
                        </div>
                    </div>
                </div>

                <div id="countdown-overlay" class="absolute inset-0 z-50 flex items-center justify-center pointer-events-none hidden">
                    <span class="text-[150px] font-bold text-white drop-shadow-2xl font-mono" id="countdown-text">3</span>
                </div>
            </div>
        </div>

        <aside class="studio-controls">
            
            <nav class="tab-nav">
                <button class="tab-btn active" onclick="UI.switchTab('adjust')" id="btn-tab-adjust">Adjust</button>
                <button class="tab-btn" onclick="UI.switchTab('filters')" id="btn-tab-filters">Filters</button>
                <button class="tab-btn" onclick="UI.switchTab('layers')" id="btn-tab-layers">Layers</button>
                <button class="tab-btn" onclick="UI.switchTab('gallery')" id="btn-tab-gallery">Library</button>
            </nav>

            <div class="control-scroll">
                
                <div id="tab-adjust" class="tab-content">
                    <div class="control-section">
                        <div class="flex justify-between mb-2">
                            <span class="section-label">Exposure</span>
                            <span id="val-brightness" class="text-xs text-blue-400 font-mono">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" id="inp-brightness" oninput="Engine.setParam('brightness', this.value)">
                    </div>

                    <div class="control-section">
                        <div class="flex justify-between mb-2">
                            <span class="section-label">Contrast</span>
                            <span id="val-contrast" class="text-xs text-blue-400 font-mono">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" id="inp-contrast" oninput="Engine.setParam('contrast', this.value)">
                    </div>

                    <div class="control-section">
                        <div class="flex justify-between mb-2">
                            <span class="section-label">Saturation</span>
                            <span id="val-saturate" class="text-xs text-blue-400 font-mono">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" id="inp-saturate" oninput="Engine.setParam('saturate', this.value)">
                    </div>

                    <div class="control-section">
                        <div class="flex justify-between mb-2">
                            <span class="section-label">Temperature</span>
                            <span id="val-warmth" class="text-xs text-blue-400 font-mono">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" id="inp-warmth" oninput="Engine.setParam('warmth', this.value)">
                    </div>

                    <div class="control-section pt-4 border-t border-white/10">
                        <button onclick="Engine.reset()" class="w-full py-2 rounded bg-white/5 hover:bg-white/10 text-xs font-bold text-gray-400 transition">RESET DEFAULTS</button>
                    </div>
                </div>

                <div id="tab-filters" class="tab-content hidden">
                    <span class="section-label">LUT Simulation</span>
                    <div class="grid grid-cols-2 gap-3" id="filter-grid">
                        </div>
                </div>

                <div id="tab-layers" class="tab-content hidden">
                    <div class="control-section">
                        <span class="section-label">Add Text</span>
                        <div class="flex gap-2">
                            <input type="text" id="text-input" placeholder="Enter caption..." class="flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                            <button onclick="Layers.addText()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded text-sm font-bold">+</button>
                        </div>
                    </div>

                    <div class="control-section">
                        <span class="section-label">Stickers</span>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="Layers.addSticker('üî•')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üî•</button>
                            <button onclick="Layers.addSticker('‚ú®')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">‚ú®</button>
                            <button onclick="Layers.addSticker('üíñ')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üíñ</button>
                            <button onclick="Layers.addSticker('üëë')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üëë</button>
                            <button onclick="Layers.addSticker('üï∂Ô∏è')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üï∂Ô∏è</button>
                            <button onclick="Layers.addSticker('üíØ')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üíØ</button>
                            <button onclick="Layers.addSticker('üåà')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üåà</button>
                            <button onclick="Layers.addSticker('üì∏')" class="aspect-square bg-white/5 hover:bg-white/10 rounded flex items-center justify-center text-xl">üì∏</button>
                        </div>
                    </div>

                    <div class="control-section">
                        <span class="section-label">Active Layers</span>
                        <div id="layer-list" class="space-y-2">
                            <p class="text-xs text-gray-500 italic p-2">No active layers.</p>
                        </div>
                    </div>
                </div>

                <div id="tab-gallery" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <span class="section-label mb-0">Session</span>
                        <button onclick="Gallery.exportAll()" class="text-blue-400 text-xs font-bold hover:underline">Download All</button>
                    </div>
                    <div id="mini-gallery" class="grid grid-cols-2 gap-2">
                        </div>
                </div>

            </div>

            <div class="shutter-container">
                <button id="shutter-button" class="shutter-btn" onclick="Engine.capture()">
                    <div class="shutter-inner"></div>
                </button>
            </div>
        </aside>

    </div>

    <script>
        /**
         * STUDIO OS ENGINE V2
         * Robust, Object-Oriented, IndexedDB backed.
         */

        // --- 1. INDEXED DB STORAGE (Robustness for huge images) ---
        const Storage = {
            dbName: 'StudioOS_DB_V2',
            version: 1,
            db: null,

            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('photos')) {
                            db.createObjectStore('photos', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e);
                });
            },

            savePhoto(blob) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['photos'], 'readwrite');
                    const store = tx.objectStore('photos');
                    const item = { id: Date.now(), blob: blob, date: new Date() };
                    store.add(item);
                    tx.oncomplete = () => resolve(item);
                    tx.onerror = (e) => reject(e);
                });
            },

            getAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(['photos'], 'readonly');
                    const store = tx.objectStore('photos');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result.reverse()); // Newest first
                });
            },

            delete(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(['photos'], 'readwrite');
                    tx.objectStore('photos').delete(id);
                    tx.oncomplete = () => resolve();
                });
            }
        };

        // --- 2. LAYER SYSTEM (Interactive Elements) ---
        const Layers = {
            items: [], // { id, type, content, x, y, scale, rotation }
            selectedId: null,

            addText() {
                const input = document.getElementById('text-input');
                const text = input.value.trim();
                if (!text) return;
                
                this.items.push({
                    id: Date.now(),
                    type: 'text',
                    content: text,
                    x: 0.5, y: 0.5, // Normalized coordinates (0-1)
                    scale: 1,
                    rotation: 0
                });
                input.value = '';
                this.renderLayerList();
                Engine.drawFrame(); // Force redraw
            },

            addSticker(emoji) {
                this.items.push({
                    id: Date.now(),
                    type: 'sticker',
                    content: emoji,
                    x: 0.5, y: 0.5,
                    scale: 1,
                    rotation: 0
                });
                this.renderLayerList();
                Engine.drawFrame();
            },

            delete(id) {
                this.items = this.items.filter(i => i.id !== id);
                this.renderLayerList();
                Engine.drawFrame();
            },

            renderLayerList() {
                const container = document.getElementById('layer-list');
                if (this.items.length === 0) {
                    container.innerHTML = `<p class="text-xs text-gray-500 italic p-2">No active layers.</p>`;
                    return;
                }
                container.innerHTML = this.items.map(item => `
                    <div class="flex items-center justify-between bg-white/5 p-2 rounded border border-white/5">
                        <span class="text-sm truncate w-32">${item.content}</span>
                        <button onclick="Layers.delete(${item.id})" class="text-red-400 hover:text-red-300 text-xs font-bold">DEL</button>
                    </div>
                `).join('');
            }
        };

        // --- 3. VIDEO & RENDER ENGINE (The core fix for "Not Normal") ---
        const Engine = {
            video: null,
            canvas: null,
            ctx: null,
            stream: null,
            
            // State
            params: { brightness: 0, contrast: 0, saturation: 0, warmth: 0 },
            filter: 'none',
            mirror: true,
            timer: 0,
            
            // Loop Control
            rafId: null,

            async init() {
                this.video = document.getElementById('source-video');
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true }); // Optimization

                try {
                    // Force HD Resolution
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: { ideal: 1920 }, height: { ideal: 1080 }, facingMode: 'user' },
                        audio: false
                    });
                    this.video.srcObject = this.stream;
                    
                    this.video.onloadedmetadata = () => {
                        this.resize();
                        document.getElementById('resolution-stat').innerText = `${this.video.videoWidth}x${this.video.videoHeight}`;
                        this.startLoop();
                    };
                } catch (e) {
                    alert("Camera Error: Please run on Localhost or HTTPS.");
                }

                window.addEventListener('resize', () => this.resize());
            },

            resize() {
                // Determine display size
                const container = this.canvas.parentElement;
                const targetW = container.offsetWidth;
                const targetH = container.offsetHeight;
                
                // Set canvas resolution to match video resolution (High quality)
                // Or match container for performance. Let's go High Quality but scaled via CSS.
                this.canvas.width = this.video.videoWidth || 1280;
                this.canvas.height = this.video.videoHeight || 720;
            },

            startLoop() {
                const loop = () => {
                    this.drawFrame();
                    this.rafId = requestAnimationFrame(loop);
                };
                loop();
            },

            // --- THE PIXEL PERFECT DRAW FUNCTION ---
            drawFrame() {
                if (!this.video || this.video.readyState < 2) return;

                const width = this.canvas.width;
                const height = this.canvas.height;

                // 1. CLEAR
                this.ctx.clearRect(0, 0, width, height);

                // 2. SETUP MIRRORING
                this.ctx.save();
                if (this.mirror) {
                    this.ctx.translate(width, 0);
                    this.ctx.scale(-1, 1);
                }

                // 3. APPLY FILTERS (Canvas API)
                // We construct a filter string. Note: Canvas 2D uses 100% as base, CSS uses different units sometimes.
                // Converting -100..100 input range to Canvas 2D percentage strings.
                
                const b = 100 + parseInt(this.params.brightness);
                const c = 100 + parseInt(this.params.contrast);
                const s = 100 + parseInt(this.params.saturation);
                
                let filterStr = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;

                // Warmth (Sepia logic)
                const w = parseInt(this.params.warmth);
                if (w > 0) filterStr += ` sepia(${w}%)`;
                else if (w < 0) filterStr += ` hue-rotate(${w/2}deg)`; // Cool shift

                // Presets
                if (this.filter === 'bw') filterStr += ' grayscale(100%)';
                if (this.filter === 'dramatic') filterStr += ' contrast(150%) saturate(50%)';
                if (this.filter === 'cyber') filterStr += ' hue-rotate(180deg) saturate(200%)';

                this.ctx.filter = filterStr;

                // 4. DRAW VIDEO (Aspect Ratio Corrected - Object Fit: Cover)
                // Actually, since we set canvas size TO video size, we just draw 0,0
                this.ctx.drawImage(this.video, 0, 0, width, height);

                this.ctx.restore(); // Undo mirror & filter for UI layers

                // 5. DRAW LAYERS (Text/Stickers)
                this.drawLayers();

                // 6. UPDATE HISTOGRAM (Pro Feature)
                this.updateHistogram();
            },

            drawLayers() {
                Layers.items.forEach(item => {
                    const x = item.x * this.canvas.width;
                    const y = item.y * this.canvas.height;
                    
                    this.ctx.save();
                    this.ctx.translate(x, y);
                    // Rotation would go here
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    
                    if (item.type === 'text') {
                        // Responsive font size
                        const size = this.canvas.width * 0.05; 
                        this.ctx.font = `700 ${size}px 'Instrument Serif'`;
                        this.ctx.fillStyle = 'white';
                        this.ctx.shadowColor = 'rgba(0,0,0,0.5)';
                        this.ctx.shadowBlur = 10;
                        this.ctx.fillText(item.content, 0, 0);
                    } else {
                        const size = this.canvas.width * 0.15;
                        this.ctx.font = `${size}px serif`;
                        this.ctx.fillText(item.content, 0, 0);
                    }
                    this.ctx.restore();
                });
            },

            // --- PRO FEATURE: RGB HISTOGRAM ---
            updateHistogram() {
                // Optimization: Update every 5 frames only
                if (Date.now() % 5 !== 0) return; 
                
                // Get small sample to performant calc
                const histCanvas = document.getElementById('histogram');
                const hCtx = histCanvas.getContext('2d');
                hCtx.drawImage(this.canvas, 0, 0, 50, 30); // Downscale draw
            },

            // --- CONTROL SETTERS ---
            setParam(key, val) {
                this.params[key] = val;
                // Update Label
                document.getElementById(`val-${key}`).innerText = val > 0 ? `+${val}` : val;
            },

            reset() {
                this.params = { brightness: 0, contrast: 0, saturation: 0, warmth: 0 };
                ['brightness', 'contrast', 'saturate', 'warmth'].forEach(k => {
                    document.getElementById(`inp-${k}`).value = 0;
                    document.getElementById(`val-${k}`).innerText = '0';
                });
                this.filter = 'none';
                this.highlightFilter('none');
            },

            setFilter(name) {
                this.filter = name;
                this.highlightFilter(name);
            },

            highlightFilter(name) {
                document.querySelectorAll('.filter-card').forEach(el => {
                    if(el.dataset.name === name) el.classList.add('ring-2', 'ring-blue-500');
                    else el.classList.remove('ring-2', 'ring-blue-500');
                });
            },

            toggleMirror() {
                this.mirror = !this.mirror;
            },

            toggleCountdown() {
                const states = [0, 3, 5, 10];
                let idx = states.indexOf(this.timer);
                this.timer = states[(idx + 1) % states.length];
                document.getElementById('timer-btn').innerText = this.timer === 0 ? '0s' : this.timer + 's';
            },

            // --- CAPTURE SEQUENCE ---
            async capture() {
                const btn = document.getElementById('shutter-button');
                btn.style.pointerEvents = 'none';

                // Countdown
                if (this.timer > 0) {
                    const ov = document.getElementById('countdown-overlay');
                    const txt = document.getElementById('countdown-text');
                    ov.classList.remove('hidden');
                    for (let i = this.timer; i > 0; i--) {
                        txt.innerText = i;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                    ov.classList.add('hidden');
                }

                // Audio
                this.playShutterSound();

                // Flash
                const flash = document.getElementById('flash');
                flash.style.opacity = 1;
                setTimeout(() => flash.style.opacity = 0, 150);

                // Export High Quality
                this.canvas.toBlob(async (blob) => {
                    await Storage.savePhoto(blob);
                    Gallery.refresh();
                    btn.style.pointerEvents = 'auto';
                }, 'image/jpeg', 0.95);
            },

            playShutterSound() {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            }
        };

        // --- 4. GALLERY UI ---
        const Gallery = {
            async refresh() {
                const photos = await Storage.getAll();
                const grid = document.getElementById('mini-gallery');
                grid.innerHTML = '';
                
                // Show last 6 in sidebar
                photos.slice(0, 6).forEach(p => {
                    const url = URL.createObjectURL(p.blob);
                    const div = document.createElement('div');
                    div.className = 'aspect-square bg-gray-800 rounded overflow-hidden border border-white/10 cursor-pointer hover:border-blue-500 transition';
                    div.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
                    div.onclick = () => this.download(p);
                    grid.appendChild(div);
                });
            },

            download(photo) {
                const url = URL.createObjectURL(photo.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `StudioOS_${photo.id}.jpg`;
                a.click();
            },

            async exportAll() {
                const photos = await Storage.getAll();
                if(photos.length === 0) return alert("Gallery empty");
                if(confirm(`Download ${photos.length} photos?`)) {
                    photos.forEach((p, i) => {
                        setTimeout(() => this.download(p), i * 500);
                    });
                }
            }
        };

        // --- 5. UI MANAGER ---
        const UI = {
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`btn-tab-${tabId}`).classList.add('active');
            },

            initFilters() {
                const container = document.getElementById('filter-grid');
                const filters = [
                    { id: 'none', label: 'Standard', color: '#3f3f46' },
                    { id: 'bw', label: 'Noir', color: '#000000' },
                    { id: 'dramatic', label: 'Drama', color: '#52525b' },
                    { id: 'cyber', label: 'Cyber', color: '#7c3aed' },
                ];

                filters.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = `filter-card h-16 rounded-lg flex items-center justify-center text-xs font-bold uppercase tracking-wider text-white shadow-lg transition transform active:scale-95 border border-white/5`;
                    btn.style.backgroundColor = f.color;
                    btn.innerText = f.label;
                    btn.dataset.name = f.id;
                    btn.onclick = () => Engine.setFilter(f.id);
                    container.appendChild(btn);
                });
                Engine.highlightFilter('none');
            }
        };

        // --- BOOTSTRAP ---
        (async function boot() {
            await Storage.init();
            await Engine.init();
            UI.initFilters();
            Gallery.refresh();
        })();

    </script>
</body>
</html>
