<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoBooth AI | Layout Studio Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #8e44ad;
            --accent: #00cec9;
            --bg: #0f1014;
            --panel: rgba(20, 20, 25, 0.95);
            --glass: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --radius: 12px;
            --range-thumb: #fff;
        }

        body.access-mode {
            --primary: #ffff00;
            --accent: #ffffff;
            --bg: #000000;
            --panel: #222222;
            --text: #ffff00;
            font-size: 1.2rem;
            font-weight: bold;
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-ui); background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- LAYOUT GRID --- */
        .app-shell { display: grid; grid-template-columns: 300px 1fr 320px; height: calc(100vh - 60px); gap: 15px; padding: 15px; }
        
        .panel {
            background: var(--panel); backdrop-filter: blur(12px); border-radius: var(--radius);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            border: 1px solid var(--glass); overflow-y: auto;
        }

        .panel-header { font-size: 0.9rem; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; border-bottom: 1px solid var(--glass); padding-bottom: 5px; margin-bottom: 5px; }

        /* --- CONTROLS --- */
        .btn {
            background: var(--glass); border: 1px solid transparent; color: var(--text); padding: 12px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
        }
        .btn:hover { background: var(--primary); transform: translateY(-1px); }
        .btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0,206,201,0.4); }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        /* Sliders */
        .slider-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.8; }
        input[type="range"] {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer;
        }

        /* --- STAGE --- */
        .stage-area { 
            position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: #000; border-radius: var(--radius); border: 1px solid var(--glass);
        }
        
        .viewport {
            width: 100%; max-width: 800px; aspect-ratio: 16/9; position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); background: #111;
        }
        
        video, canvas { width: 100%; height: 100%; object-fit: contain; }
        /* Mirror effect only on live video, not canvas result */
        video { transform: scaleX(-1); } 

        /* --- OVERLAYS --- */
        .face-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 260px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%; pointer-events: none; opacity: 0; transition: 0.3s;
        }
        .face-guide.active { opacity: 1; border-color: var(--accent); }

        .mascot-bubble {
            position: absolute; bottom: 20px; right: 20px; background: white; color: black;
            padding: 10px 15px; border-radius: 15px 15px 0 15px; font-weight: bold;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none;
        }

        /* --- LAYOUT PREVIEWS --- */
        .layout-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .layout-opt { 
            aspect-ratio: 1; background: var(--glass); border-radius: 4px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 2px;
        }
        .layout-opt:hover { background: rgba(255,255,255,0.1); }
        .layout-opt.active { border: 2px solid var(--accent); }
        /* Mini icons for layouts */
        .mini-box { background: rgba(255,255,255,0.3); }

        /* --- FOOTER --- */
        .footer-nav { height: 60px; background: var(--panel); border-top: 1px solid var(--glass); display: flex; align-items: center; justify-content: center; gap: 30px; }
        .step { opacity: 0.4; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .step.active { opacity: 1; color: var(--accent); font-weight: bold; }
        .step-num { background: currentColor; color: var(--bg); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.7rem; }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { width: 500px; background: var(--panel); border: 1px solid var(--glass); border-radius: var(--radius); padding: 30px; text-align: center; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="app-shell">
        <aside class="panel">
            <div class="panel-header">NeoBooth Studio</div>
            
            <div class="btn-group">
                <button class="btn active" id="modeSingle" onclick="setMode('single')">Single</button>
                <button class="btn" id="modeBurst" onclick="setMode('burst')">Burst (4)</button>
            </div>

            <div class="panel-header" style="margin-top:20px;">Smart Tools</div>
            <button class="btn" id="btnAutoFrame" onclick="toggleAutoFrame()">
                <span>‚õ∂</span> Auto-Alignment Guide
            </button>
            <div class="slider-row" style="margin-top:10px;">
                <div class="slider-label"><span>Interface Scale</span></div>
                <input type="range" min="80" max="130" value="100" oninput="document.body.style.zoom = this.value+'%'">
            </div>

            <div class="panel-header" style="margin-top:auto;">Accessibility</div>
            <div class="btn-group">
                <button class="btn" onclick="document.body.classList.toggle('access-mode')">Contrast</button>
                <button class="btn" onclick="speak('Voice guidance active')">Voice</button>
            </div>
        </aside>

        <main class="stage-area">
            <div class="viewport" id="viewport">
                <video id="video" autoplay playsinline></video>
                <canvas id="mainCanvas" style="display:none;"></canvas>
                <div class="face-guide" id="faceGuide"></div>
                <div id="countdown" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:8rem; color:white; font-weight:900; text-shadow:0 0 20px black; display:none;">3</div>
                <div class="mascot-bubble" id="mascotMsg">Ready?</div>
            </div>

            <button id="snapBtn" onclick="startCapture()" style="margin-top:20px; width:70px; height:70px; border-radius:50%; background:var(--accent); border:4px solid white; box-shadow:0 0 30px var(--accent); cursor:pointer; transition:0.2s;"></button>
            
            <div style="margin-top:10px; font-size:0.8rem; opacity:0.5">
                <span id="statusText">Ready to Capture</span>
            </div>
        </main>

        <aside class="panel" id="editPanel" style="opacity:0.5; pointer-events:none;">
            <div class="panel-header">Layout Studio</div>
            <div class="layout-grid">
                <div class="layout-opt" onclick="applyLayout('single')">
                    <div style="width:80%; height:80%; background:#555;"></div>
                </div>
                <div class="layout-opt" onclick="applyLayout('strip')">
                    <div style="width:60%; height:20%; background:#fff; margin:1px;"></div>
                    <div style="width:60%; height:20%; background:#fff; margin:1px;"></div>
                    <div style="width:60%; height:20%; background:#fff; margin:1px;"></div>
                </div>
                <div class="layout-opt" onclick="applyLayout('grid2x2')">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px; width:80%; height:80%;">
                        <div class="mini-box"></div><div class="mini-box"></div>
                        <div class="mini-box"></div><div class="mini-box"></div>
                    </div>
                </div>
            </div>

            <div class="slider-row" style="margin-top:10px;">
                <div class="slider-label"><span>Frame Padding</span></div>
                <input type="range" min="0" max="50" value="10" oninput="state.padding=parseInt(this.value); renderComposite()">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Corner Rounding</span></div>
                <input type="range" min="0" max="50" value="0" oninput="state.rounding=parseInt(this.value); renderComposite()">
            </div>

            <div class="panel-header" style="margin-top:20px;">Color Grading</div>
            <div class="slider-row">
                <div class="slider-label"><span>Brightness</span></div>
                <input type="range" min="50" max="150" value="100" oninput="updateColor('brightness', this.value)">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Contrast</span></div>
                <input type="range" min="50" max="150" value="100" oninput="updateColor('contrast', this.value)">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Sharpness (Simulated)</span></div>
                <input type="range" min="0" max="100" value="0" oninput="state.color.sharpness=this.value; renderComposite()">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Warmth (RGB Bal)</span></div>
                <input type="range" min="-50" max="50" value="0" oninput="state.color.warmth=this.value; renderComposite()">
            </div>

            <button class="btn active" style="margin-top:auto;" onclick="openShareModal()">Proceed to Share ‚Üí</button>
        </aside>
    </div>

    <footer class="footer-nav">
        <div class="step active" id="step1"><div class="step-num">1</div> Capture</div>
        <div class="step" id="step2"><div class="step-num">2</div> Layout</div>
        <div class="step" id="step3"><div class="step-num">3</div> Save</div>
    </footer>

    <div class="modal" id="shareModal">
        <div class="modal-card">
            <h2 style="color:var(--accent)">Privacy & Save</h2>
            <p style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">
                NeoBooth operates locally. Your photos never leave this device. 
                Please download your creation below.
            </p>
            
            <div style="background:white; width:fit-content; margin:0 auto; padding:10px; border-radius:8px;">
                <div id="qrcode"></div>
            </div>
            <div style="font-size:0.7rem; color:gray; margin-top:5px;">Scan to view Privacy Policy</div>

            <div class="btn-group" style="margin-top:20px;">
                <button class="btn active" onclick="downloadImage()">‚¨á Download Image</button>
                <button class="btn" onclick="simulateUpload()">‚òÅ Cloud Save (Mock)</button>
            </div>
            <button class="btn danger" style="margin-top:10px; width:100%" onclick="resetApp()">Close & New Session</button>
            
            <div style="margin-top:20px; font-size:0.7rem; opacity:0.5;">
                v4.2.0 | Standard: WCAG 2.1 | Local Processing Only
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            mode: 'single', // single, burst
            photos: [],     // Array of captured Image objects
            layout: 'single', // single, strip, grid2x2
            padding: 10,
            rounding: 0,
            color: { brightness: 100, contrast: 100, saturation: 100, sharpness: 0, warmth: 0 },
            isCapturing: false
        };

        const video = document.getElementById('video');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const mascot = document.getElementById('mascotMsg');

        // --- CAMERA SETUP ---
        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
            .then(stream => video.srcObject = stream)
            .catch(e => showMascot("Camera Error! üòµ"));

        // --- CORE FUNCTIONS ---
        
        function setMode(m) {
            state.mode = m;
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m === 'single' ? 'modeSingle' : 'modeBurst').classList.add('active');
            showMascot(m === 'single' ? "Single Shot Mode" : "Burst: Takes 4 Pics!");
        }

        function toggleAutoFrame() {
            document.getElementById('faceGuide').classList.toggle('active');
            showMascot("Align face in circle!");
        }

        function startCapture() {
            if(state.isCapturing) return;
            state.isCapturing = true;
            state.photos = []; // Reset photos
            
            // Logic: If Single, take 1. If Burst, take 4.
            let totalShots = state.mode === 'single' ? 1 : 4;
            let currentShot = 0;

            const takeNext = () => {
                if(currentShot >= totalShots) {
                    finishCaptureSequence();
                    return;
                }
                
                // Countdown
                let count = 3;
                document.getElementById('countdown').style.display = 'block';
                const timer = setInterval(() => {
                    document.getElementById('countdown').innerText = count;
                    if(count === 0) {
                        clearInterval(timer);
                        document.getElementById('countdown').style.display = 'none';
                        
                        // Flash
                        const f = document.createElement('div');
                        f.style.cssText = "position:absolute; inset:0; background:white; z-index:99; animation:popIn 0.2s reverse";
                        document.querySelector('.stage-area').appendChild(f);
                        setTimeout(() => f.remove(), 200);

                        // Capture Frame to Memory
                        const tempC = document.createElement('canvas');
                        tempC.width = video.videoWidth; tempC.height = video.videoHeight;
                        const tCtx = tempC.getContext('2d');
                        tCtx.translate(tempC.width, 0); tCtx.scale(-1, 1); // Mirror capture
                        tCtx.drawImage(video, 0, 0);
                        
                        const img = new Image();
                        img.src = tempC.toDataURL();
                        img.onload = () => {
                            state.photos.push(img);
                            currentShot++;
                            takeNext();
                        };
                    }
                    count--;
                }, 800);
            };

            takeNext();
        }

        function finishCaptureSequence() {
            state.isCapturing = false;
            // Switch UI to Edit Mode
            video.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('editPanel').style.opacity = '1';
            document.getElementById('editPanel').style.pointerEvents = 'auto';
            document.getElementById('snapBtn').style.display = 'none';
            document.getElementById('statusText').innerText = "Layout & Editing";
            
            // Auto-select layout based on shot count
            state.layout = state.mode === 'single' ? 'single' : 'grid2x2';
            
            updateStep(2);
            renderComposite();
            showMascot("Time to customize! üé®");
        }

        // --- THE COMPOSITOR ENGINE (Layout Studio) ---
        function applyLayout(l) {
            state.layout = l;
            renderComposite();
        }

        function updateColor(prop, val) {
            state.color[prop] = val;
            renderComposite();
        }

        function renderComposite() {
            if(state.photos.length === 0) return;

            // Canvas Setup (High Res)
            const w = 1280; 
            const h = 720;
            canvas.width = w; canvas.height = h;
            
            // Background
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, w, h);

            // Filter Application (Applied to whole context or per image)
            const filters = `brightness(${state.color.brightness}%) contrast(${state.color.contrast}%) saturate(${state.color.saturation}%)`;
            ctx.filter = filters;

            // Layout Logic
            const p = state.padding;
            const r = state.rounding;
            
            const drawFrame = (img, x, y, dw, dh) => {
                ctx.save();
                // Rounded Corners Path
                ctx.beginPath();
                ctx.roundRect(x, y, dw, dh, r);
                ctx.clip();
                
                // Draw Image
                // Simulating "Cover" fit
                const ratio = Math.max(dw / img.width, dh / img.height);
                const centerShift_x = (dw - img.width * ratio) / 2;
                const centerShift_y = (dh - img.height * ratio) / 2;
                ctx.drawImage(img, 0, 0, img.width, img.height, x + centerShift_x, y + centerShift_y, img.width * ratio, img.height * ratio);
                
                // Warmth Overlay (RGB Balance Simulation)
                if(state.color.warmth !== 0) {
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.fillStyle = state.color.warmth > 0 ? `rgba(255, 100, 0, ${state.color.warmth/200})` : `rgba(0, 100, 255, ${Math.abs(state.color.warmth)/200})`;
                    ctx.fillRect(x,y,dw,dh);
                }

                ctx.restore();
            };

            // Layout Definitions
            if(state.layout === 'single') {
                drawFrame(state.photos[0], p, p, w-(p*2), h-(p*2));
            } 
            else if (state.layout === 'grid2x2') {
                const cellW = (w - (p*3)) / 2;
                const cellH = (h - (p*3)) / 2;
                // Loop through 4 slots. If photo exists use it, else repeat last photo
                for(let i=0; i<4; i++) {
                    const img = state.photos[i] || state.photos[state.photos.length-1];
                    const x = p + (i%2) * (cellW + p);
                    const y = p + (Math.floor(i/2)) * (cellH + p);
                    drawFrame(img, x, y, cellW, cellH);
                }
            }
            else if (state.layout === 'strip') {
                // Vertical strip style (using canvas width differently usually, but fitting to 16:9 here)
                const slotW = (w - (p*4)) / 3;
                const slotH = h - (p*2);
                for(let i=0; i<3; i++) {
                    const img = state.photos[i] || state.photos[0];
                    const x = p + i * (slotW + p);
                    drawFrame(img, x, p, slotW, slotH);
                }
            }

            // Sharpness (Simulated via overlay)
            if(state.color.sharpness > 0) {
                // In real app, convolution matrix. Here, generic overlay hint.
                ctx.globalCompositeOperation = 'overlay';
                ctx.fillStyle = `rgba(128,128,128, ${state.color.sharpness/200})`;
                ctx.fillRect(0,0,w,h);
            }
        }

        // --- SHARING ---
        function openShareModal() {
            document.getElementById('shareModal').style.display = 'flex';
            updateStep(3);
            
            // Generate Privacy QR
            const qr = document.getElementById('qrcode');
            qr.innerHTML = '';
            new QRCode(qr, {
                text: "https://neobooth.com/privacy", // Points to policy, NOT image
                width: 128, height: 128
            });
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `neobooth_studio_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            showMascot("Saved to device! üíæ");
        }

        function simulateUpload() {
            const btn = event.target;
            const original = btn.innerText;
            btn.innerText = "Uploading...";
            setTimeout(() => {
                btn.innerText = "Uploaded! (Mock)";
                showMascot("Securely stored in cloud! ‚òÅÔ∏è");
                setTimeout(() => btn.innerText = original, 2000);
            }, 1500);
        }

        function resetApp() {
            document.getElementById('shareModal').style.display = 'none';
            video.style.display = 'block';
            canvas.style.display = 'none';
            document.getElementById('editPanel').style.opacity = '0.5';
            document.getElementById('editPanel').style.pointerEvents = 'none';
            document.getElementById('snapBtn').style.display = 'block';
            state.isCapturing = false;
            updateStep(1);
        }

        // --- UTILS ---
        function showMascot(txt) {
            mascot.innerText = txt;
            mascot.style.display = 'block';
            speak(txt);
            setTimeout(() => mascot.style.display = 'none', 3000);
        }

        function speak(txt) {
            // Check if voice is toggled on (omitted UI state for brevity, assuming intent)
            // window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
        }

        function updateStep(n) {
            document.querySelectorAll('.step').forEach((s, i) => s.classList.toggle('active', i+1 === n));
        }
    </script>
</body>
</html>
